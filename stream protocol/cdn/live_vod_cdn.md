<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Segoe UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
h1
	{mso-style-link:"标题 1 字符";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:"Calibri",sans-serif;
	font-weight:bold;}
h2
	{mso-style-link:"标题 2 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Cambria",serif;
	font-weight:bold;}
h3
	{mso-style-link:"标题 3 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri",sans-serif;
	font-weight:bold;}
h4
	{mso-style-link:"标题 4 字符";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria",serif;
	font-weight:bold;}
h5
	{mso-style-link:"标题 5 字符";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Calibri",sans-serif;
	font-weight:bold;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"页眉 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"页脚 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"标题 字符";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	text-align:center;
	font-size:16.0pt;
	font-family:"Cambria",serif;
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p
	{margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:宋体;}
pre
	{mso-style-link:"HTML 预设格式 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:宋体;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"批注框文本 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	font-size:10.5pt;
	font-family:"Calibri",sans-serif;}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:24.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria",serif;
	color:#365F91;
	font-weight:bold;}
span.cnblogscodecopy
	{mso-style-name:cnblogs_code_copy;}
span.HTML
	{mso-style-name:"HTML 预设格式 字符";
	mso-style-link:"HTML 预设格式";
	font-family:宋体;}
span.a
	{mso-style-name:"批注框文本 字符";
	mso-style-link:批注框文本;}
span.1
	{mso-style-name:"标题 1 字符";
	mso-style-link:"标题 1";
	font-weight:bold;}
span.2
	{mso-style-name:"标题 2 字符";
	mso-style-link:"标题 2";
	font-family:"Cambria",serif;
	font-weight:bold;}
span.3
	{mso-style-name:"标题 3 字符";
	mso-style-link:"标题 3";
	font-weight:bold;}
span.highlight
	{mso-style-name:highlight;}
span.a0
	{mso-style-name:"标题 字符";
	mso-style-link:标题;
	font-family:"Cambria",serif;
	font-weight:bold;}
span.4
	{mso-style-name:"标题 4 字符";
	mso-style-link:"标题 4";
	font-family:"Cambria",serif;
	font-weight:bold;}
span.5
	{mso-style-name:"标题 5 字符";
	mso-style-link:"标题 5";
	font-weight:bold;}
span.a1
	{mso-style-name:"页眉 字符";
	mso-style-link:页眉;}
span.a2
	{mso-style-name:"页脚 字符";
	mso-style-link:页脚;}
span.apple-tab-span
	{mso-style-name:apple-tab-span;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link=blue vlink=purple style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<h1><a name="_Toc435713708"></a><a name="_Toc33272370"><span style='font-family:
宋体'>直点播平台</span><span lang=EN-US>CDN</span></a><span style='font-family:宋体'>方案</span><span
lang=EN-US>-</span><span style='font-family:宋体'>（基于开源项目）</span></h1>

<p class=MsoTocHeading><span style='font-family:宋体'>目录</span></p>

<p class=MsoToc1><a href="#_Toc33272370"><span style='font-family:宋体'>直点播平台</span><span
lang=EN-US>CDN</span><span style='font-family:宋体'>方案</span><span lang=EN-US>-</span><span
style='font-family:宋体'>（基于开源项目）</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc1><a href="#_Toc33272371"><span lang=EN-US>1.</span><span
style='font-family:宋体'>简介</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc1><a href="#_Toc33272372"><span lang=EN-US>2.</span><span
style='font-family:宋体'>集群与负载均衡及应用</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272373"><span lang=EN-US>2.1 </span><span
style='font-family:宋体'>四层负载均衡</span><span lang=EN-US>LVS</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272374"><span lang=EN-US>2.1.1 LVS</span><span
style='font-family:宋体'>集群的组成</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272375"><span lang=EN-US>2.1.2 IP</span><span
style='font-family:宋体'>负载均衡技术</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272376"><span lang=EN-US>2.1.3 </span><span
style='font-family:宋体'>调度算法</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272377"><span lang=EN-US>2.2 </span><span
style='font-family:宋体'>高可用软件</span><span lang=EN-US> Keepalived</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272378"><span lang=EN-US>2.3 </span><span
style='font-family:宋体'>流媒体直播服务器</span><span lang=EN-US>SRS</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272379"><span lang=EN-US>2.4 Web</span><span
style='font-family:宋体'>缓冲服务器</span><span lang=EN-US>Squid</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272380"><span lang=EN-US>2.5 </span><span
style='font-family:宋体'>负载均衡应用</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272381"><span lang=EN-US>2.5.1 </span><span
style='font-family:宋体'>系统环境</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272382"><span lang=EN-US>2.5.2 </span><span
style='font-family:宋体'>配置真实主机</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272383"><span lang=EN-US>2.5.3 </span><span
style='font-family:宋体'>配置</span><span lang=EN-US>lvs</span><span
style='font-family:宋体'>与</span><span lang=EN-US>keepalived</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc1><a href="#_Toc33272384"><span lang=EN-US>3.</span><span
style='font-family:宋体'>全局负载均衡及实现</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272385"><span lang=EN-US>3.1 DSN</span><span
style='font-family:宋体'>简介</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272386"><span lang=EN-US>3.1.1</span><span
style='font-family:宋体'>根域与顶级域名服务器</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272387"><span lang=EN-US>3.1.2</span><span
style='font-family:宋体'>本地</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272388"><span lang=EN-US>3.1.3</span><span
style='font-family:宋体'>域名资源记录类型</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272389"><span lang=EN-US>3.2 </span><span
style='font-family:宋体'>基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>解析实现</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>方法</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272390"><span lang=EN-US>3.3 BIND</span><span
style='font-family:宋体'>开源域名服务器</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272391"><span lang=EN-US>3.4 </span><span
style='font-family:宋体'>全局负载均衡实现</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272392"><span lang=EN-US>3.4.1 </span><span
style='font-family:宋体'>系统环境</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272393"><span lang=EN-US>3.4.2 </span><span
style='font-family:宋体'>安装与编译</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272394"><span lang=EN-US>3.4.3</span><span
style='font-family:宋体'>配置</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272395"><span lang=EN-US>3.4.4 </span><span
style='font-family:宋体'>测试</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc1><a href="#_Toc33272396"><span lang=EN-US>4.</span><span
style='font-family:宋体'>网络存储及实现</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272397"><span lang=EN-US>4.1</span><span
style='font-family:宋体'>网络存储技术</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272398"><span lang=EN-US>4.1.1</span><span
style='font-family:宋体'>直接附加存储</span><span lang=EN-US>(DAS)</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'> </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272399"><span lang=EN-US>4.1.2</span><span
style='font-family:宋体'>网络附加存储</span><span lang=EN-US>(NAS)</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'> </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272400"><span lang=EN-US>4.1.3</span><span
style='font-family:宋体'>存储区域网</span><span lang=EN-US>(SAN)</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'> </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272401"><span lang=EN-US>4.1.4 iSCSI</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'> </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc2><a href="#_Toc33272402"><span lang=EN-US>4.2</span><span
style='font-family:宋体'>分布式存储</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272403"><span lang=EN-US>4.2.1</span><span
style='font-family:宋体'>分布式存储实现实例</span><span lang=EN-US>MooseFS</span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>. </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoToc3><a href="#_Toc33272404"><span lang=EN-US>4.2.2Moosefs</span><span
style='font-family:宋体'>安装与配置</span><span lang=EN-US style='color:windowtext;
display:none;text-decoration:none'>... </span><span
lang=EN-US style='color:windowtext;display:none;text-decoration:none'>1</span></a></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='font-size:22.0pt'>&nbsp;</span></p>

<h1><a name="_Toc33272371"></a><a name="_Toc436141397"><span lang=EN-US>1.</span></a><span
style='font-family:宋体'>简介</span></h1>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>该文档主要介绍利用现在一些成熟的开源项目，如何搭建一套高可用集群点播与直播系统，负载均衡缓冲集群，再配合基于</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>全局负载均衡</span><span
lang=EN-US>(GLBS)</span><span style='font-family:宋体'>，共享存储或分布式存储，实现一套具有</span><span
lang=EN-US>cdn</span><span style='font-family:宋体'>功能的点播与直播系统。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>文档中实践部分都是在虚拟机的搭建起来，只是实验环境，主要学习与研究使用，跟实际的生产环境还是有些不同，还需要配合业务系统，可能有些地方需要修改，需要根据实际应用来配置与修改。但基本原理是不会变，通用的。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>缓冲技术主要将用户访问的内容缓存到网络边缘处，以实现用户就近服务，改善服务质量。当一台缓冲设备无法满足服务响应要求时，就需要考虑通过一组服务器形成缓冲集群为用户提供服务。本文负载均衡缓冲集群采用开源</span><span
lang=EN-US>lvs+keepalived</span><span style='font-family:宋体'>实现高可用负载均衡</span><span
lang=EN-US>, squid</span><span style='font-family:宋体'>实现点播缓冲</span><span
lang=EN-US>,SRS</span><span style='font-family:宋体'>实现直播缓冲。在集群与负载均衡及实现章节会详细介绍这些开源技术</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>集群与本地负载均衡实用了服务器群的高可用性，但如果集群所在的数据中心断电，或</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>底层网络故障，又或者自然灾害等等都可能使数据中心瘫痪。在一个数据中心内无论采用怎样的技术保障高可用性，还是有一些不可抗力因素导致整个集群无法工作。所以通常把服务器分散部署，放在多个数据中心里。另外，</span><span
lang=EN-US>cdn</span><span style='font-family:宋体'>系统总是希望使用离用户最近的设备为用户提供服务，这样就需要在全网不同位置部署多个节点。全局负载均衡（</span><span
lang=EN-US>GLSB</span><span style='font-family:宋体'>）就负载解决多个节点之间相互协同的问题，实现整个系统的大规模服务能力和高可用性</span><span
lang=EN-US>.</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>GLSB</span><span
style='font-family:宋体'>这层的负载均衡主要是在多个节点之间进行，其结果可能直接终结负载均衡过程，也可能将用户交付下一层次</span><span
lang=EN-US>(</span><span style='font-family:宋体'>区域或都本地</span><span lang=EN-US>)</span><span
style='font-family:宋体'>的负载均衡系统进行处理</span><span lang=EN-US>.</span><span
style='font-family:宋体'>现在通常采用如下几种调度机制应用于</span><span lang=EN-US>GLSB. </span><span
style='font-family:宋体'>最通用的基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>解析方式，基于</span><span lang=EN-US>http</span><span
style='font-family:宋体'>重定向，</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>路由等。该文档主要介绍基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>方式，也是目前商用</span><span lang=EN-US>CDN</span><span
style='font-family:宋体'>用得比较多。</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>采用开源项目</span><span lang=EN-US>BIND. </span><span
style='font-family:宋体'>在</span><span lang=EN-US>GLSB</span><span
style='font-family:宋体'>章节会详细介绍。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; <img width=678
height=708 src="live_vod_cdn.files/image001.png"></span></p>

<h1><a name="_Toc33272372"></a><a name="_Toc436141398"></a><a
name="_Toc435713709"><span lang=EN-US>2.</span></a><span style='font-family:
宋体'>集群与负载均衡及</span><span style='font-family:宋体'>应用</span></h1>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>服务器集群是指将很多彼此相互独立的服务器通过高速网络连接在一起，形成一个并行或分布式系统。这些服务器运行一系列共同的程序，向外提供单一的系统映射，提供一个服务。从外部来看，整个集群就像是一台具有统一输入、输出的服务器一样。使用集群能提高性能，降低成本，提高可扩展性，增加可用性。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>负载均衡是将负载（工作任务）进行平衡、分摊到多个操作单元上进行执行，从而实现整个系统共同完成任务。服务器负载均衡是将客户端请求在集群中的服务器上实现均衡分发的技术。按照位于七层网络协议栈的不同层的划分，服务器负载均衡可以分为四层</span><span
lang=EN-US>(L4)</span><span style='font-family:宋体'>和七层负载均衡两种。其中，</span><span
lang=EN-US>L4</span><span style='font-family:宋体'>负载均衡是基于流的服务器负载均衡，能够对报文进行逐流分发，即将同一条流的报文分发给同一台服务器</span><span
lang=EN-US>;L7</span><span style='font-family:宋体'>负载均衡是基于内容的服务器负载均衡，能够对七层报文内容进行深度解析，并根据其中的关键字进行逐包转发，按照既定策略将连接导向指定的服务器。两者相比较，</span><span
lang=EN-US>L4</span><span style='font-family:宋体'>负载均衡因无法对七层业务实现按内容分发，限制了它的适用范围，因此</span><span
lang=EN-US>L7</span><span style='font-family:宋体'>负载均衡因无法对七层业务实现按内容分发，限制了它的适用范围，因此</span><span
lang=EN-US>L7</span><span style='font-family:宋体'>负载均衡受到了业界的极大重视并日渐成为服务器负载均衡的主流。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>四层负载均衡主要有</span><span
lang=EN-US>NAT</span><span style='font-family:宋体'>方式和</span><span lang=EN-US>DR</span><span
style='font-family:宋体'>方式两种类型，它们适用于不同的应用场景。</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>NAT</span><span
style='font-family:宋体'>方式</span><span lang=EN-US>L4</span><span
style='font-family:宋体'>负载均衡的典型组网</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=530
height=265 id="图片 19" src="live_vod_cdn.files/image002.png"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>工作流程</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=545
height=357 id="图片 23" src="live_vod_cdn.files/image003.png"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>DR</span><span
style='font-family:宋体'>方式</span><span lang=EN-US>L4</span><span
style='font-family:宋体'>负载均衡的典型组网</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=554
height=277 id="图片 15" src="live_vod_cdn.files/image004.png"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>工作流程</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=554
height=351 id="图片 24" src="live_vod_cdn.files/image005.jpg"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>L7</span><span
style='font-family:宋体'>负载均衡的典型组网</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=554
height=403 id="图片 12" src="live_vod_cdn.files/image006.png"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>工作流程</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US><img width=554
height=474 id="图片 36" src="live_vod_cdn.files/image007.jpg"></span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span style='font-family:宋体'>在应用中较多的负载均衡器硬件有</span><span
lang=EN-US>F5BIG-IP, </span><span style='font-family:宋体'>软件有</span><span
lang=EN-US>LVS</span><span style='font-family:宋体'>、</span><span lang=EN-US>Nginx</span><span
style='font-family:宋体'>及</span><span lang=EN-US>HAproxy,</span><span
style='font-family:宋体'>高可用软件有</span><span lang=EN-US>Heartbeat</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>、成熟的</span><span lang=EN-US>Linux</span><span
style='font-family:宋体'>集群架构有</span><span lang=EN-US>LVS+Keepalived</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Nginx|HAproxy+Keepalived</span><span
style='font-family:宋体'>及</span><span lang=EN-US>DRBD+Heartbeart</span><span
style='font-family:宋体'>。在该文实例中主要使用</span><span lang=EN-US>lvs</span><span
style='font-family:宋体'>负载均衡，</span><span lang=EN-US>keepalived</span><span
style='font-family:宋体'>实现负载均衡双机热备，</span><span lang=EN-US>squid</span><span
style='font-family:宋体'>点播边缘缓冲，</span><span lang=EN-US>srs</span><span
style='font-family:宋体'>直播边缘缓冲。客户端</span> <span style='font-family:宋体'>通过</span><span
lang=EN-US>lvs</span><span style='font-family:宋体'>虚拟地址接入系统，可以发布直播，播放直播，以及回放直播录像。</span></p>

<p class=MsoNormal><span style='font-family:宋体'>请参考如下系统架构图。</span></p>

<h2><a name="_Toc33272373"></a><a name="_Toc436141399"></a><a
name="_Toc435713710"><span lang=EN-US>2.1 </span></a><span style='font-family:
宋体'>四层负载均衡</span><span lang=EN-US>LVS</span></h2>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>LVS</span><span
style='font-family:宋体'>是</span><span lang=EN-US>Linux Virtual Server</span><span
style='font-family:宋体'>的简写，意即</span><span lang=EN-US>Linux</span><span
style='font-family:宋体'>虚拟服务器，是一个虚拟的服务器集群系统。本项目在</span><span lang=EN-US>1998</span><span
style='font-family:宋体'>年</span><span lang=EN-US>5</span><span style='font-family:
宋体'>月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>利用</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>可以实现高可用的、可伸缩的</span><span lang=EN-US>Web</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Mail</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Cache</span><span
style='font-family:宋体'>和</span><span lang=EN-US>Media</span><span
style='font-family:宋体'>等网络服务。并在此基础上开发支持庞大用户数的、可伸缩的、高可用的应用。</span></p>

<h3><a name="_Toc33272374"><span lang=EN-US>2.1.1 LVS</span></a><span
style='font-family:宋体'>集群的组成</span></h3>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp; &nbsp;&nbsp;&nbsp;</span><span
style='font-family:宋体'>利用</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>架设的服务器集群系统由</span><span lang=EN-US>3</span><span
style='font-family:宋体'>个部分组成：负载调度器</span><span lang=EN-US>(Load Balance),</span><span
style='font-family:宋体'>服务器池</span><span lang=EN-US>(server pool)</span><span
style='font-family:宋体'>，共享存储</span><span lang=EN-US>(Shared Storage)</span><span
style='font-family:宋体'>。在用户看来，整个</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>集群系统的所有内部应用结构都是透明的，最终用户只是在使用一个虚拟服务器提供的高性能服务。</span></p>

<p class=MsoNoSpacing><span lang=EN-US>LVS</span><span style='font-family:宋体'>体系结构如图所示。</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img width=554 height=516 id="图片 37"
src="live_vod_cdn.files/image008.jpg"></span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>下面对</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>的各个组成部分进行详细介绍。</span></p>

<p class=MsoNoSpacing><b><span style='font-family:宋体'>负载调度器</span><span
lang=EN-US>: </span></b><span style='font-family:宋体'>它是整个集群对外的前端机，负责将用户的请求发送到一组服务器上执行，而用户认为服务是来自一个</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址（虚拟</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址）上的</span></p>

<p class=MsoNoSpacing><b><span style='font-family:宋体'>服务器池</span><span
lang=EN-US>:</span></b><span style='font-family:宋体'>它是一组真正执行客户请求的服务器，执行的服务有</span><span
lang=EN-US>Web,Mail,FTP</span><span style='font-family:宋体'>和</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>，流媒体等。</span></p>

<p class=MsoNoSpacing><b><span style='font-family:宋体'>共享存储</span><span
lang=EN-US>:</span></b><span style='font-family:宋体'>它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>调度器是服务器集群系统的唯一入口点，它可以采用</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>负载均衡技术和基于内容的请求分发技术，或将两者相结合。在</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>负载均衡技术中，要求服务器池拥有相同的内容，提供相同的服务。当用户请求到达时，调度器只根据服务器的负载情况和设定的调度算法从服务器池中选出一台服务器，将该请求转发到选出的服务器上，并记录这一次调度。当这个请求的其他报文到达时，也会被转发到前面选出的服务器上。在基于内容的请求分发技术中，服务器可以提供不同的服务，当用户请求到达时，调度器可根据请求的内容选择执行请求的服务器。因为所有的操作都是在</span><span
lang=EN-US>Linux</span><span style='font-family:宋体'>操作系统的核心空间中完成的，它的调度开销很小，所以它具有很高的吞吐率。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>服务器池的节点数目是可变的。当整个系统的负载超过目前所有节点的处理能力时，可以在服务器池中增加服务器来满足不断增长的请求负载。对大多数网络服务来说，请求间的相关性并不是很强，请求可以在不同的节点上并行执行，所以整个系统的性能基本上可以随着服务器池的节点数目的增加而线性增长。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>共享存储通常是数据库，网络文件系统或分布文件系统。服务器节点需要动态更新的数据一般存储在数据库系统中，同时数据库会保证并发访问时数据的一致性。静态的数据可以存储在网络文件系统</span><span
lang=EN-US>(</span><span style='font-family:宋体'>如</span><span lang=EN-US>NFS/CIFS)</span><span
style='font-family:宋体'>中，但网络文件系统的伸缩能力有限，一般来说，</span><span lang=EN-US>NFS/CI<br>
FS</span><span style='font-family:宋体'>服务器只能支持</span><span lang=EN-US>3-6</span><span
style='font-family:宋体'>个敏忙的服务器节点。规模较大的集群系统可以考虑用分布式文件系统，如</span><span
lang=EN-US>AFS</span><span style='font-family:宋体'>、</span><span lang=EN-US>GFS</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Cada</span><span
style='font-family:宋体'>和</span><span lang=EN-US>Intermezzo</span><span
style='font-family:宋体'>等。分布式文件系统可以为各服务器提供共享的存储区，它们访问分布式文件系统就像访问本地文件系统一样。同时，分布式文件系统可提供良好的伸缩性和可用性。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>目前有三种</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>负载均衡技术（</span><span
lang=EN-US>VS/NAT</span><span style='font-family:宋体'>、</span><span lang=EN-US>VS/TUN</span><span
style='font-family:宋体'>和</span><span lang=EN-US>VS/DR</span><span
style='font-family:宋体'>）；十种调度算法（</span><span lang=EN-US>rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq</span><span
style='font-family:宋体'>）。</span></p>

<h3><a name="_Toc33272375"><span lang=EN-US>2.1.2 IP</span></a><span
style='font-family:宋体'>负载均衡技术</span></h3>

<h5><span lang=EN-US>NAT</span><span style='font-family:宋体'>模式（</span><span
lang=EN-US>VS-NAT</span><span style='font-family:宋体'>）</span></h5>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>原理：</span></b><span style='font-family:宋体'>就是把客户端发来的数据包的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>头的目的地址，在负载均衡器上换成其中一台</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>的</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址，并发至此</span><span lang=EN-US>RS</span><span
style='font-family:宋体'>来处理</span><span lang=EN-US>,RS</span><span
style='font-family:宋体'>处理完成后把数据交给经过负载均衡器</span><span lang=EN-US>,</span><span
style='font-family:宋体'>负载均衡器再把数据包的原</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址改为自己的</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>，将目的地址改为客户端</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址即可</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>期间</span><span lang=EN-US>,</span><span
style='font-family:宋体'>无论是进来的流量</span><span lang=EN-US>,</span><span
style='font-family:宋体'>还是出去的流量</span><span lang=EN-US>,</span><span
style='font-family:宋体'>都必须经过负载</span> <span style='font-family:宋体'>均衡器</span><span
style='font-family:"MS Mincho"'>&#65377;</span></p>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>优点：</span></b><span style='font-family:宋体'>集群中的物理服务器可以使用任何支持</span><span
lang=EN-US>TCP/IP</span><span style='font-family:宋体'>操作系统，只有负载均衡器需要一个合法的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址。</span></p>

<p class=MsoNoSpacing style='margin-left:36.15pt;text-indent:-36.15pt'><b><span
style='font-family:宋体'>缺点：</span></b><span style='font-family:宋体'>扩展性有限。当服务器节点（普通</span><span
lang=EN-US>PC</span><span style='font-family:宋体'>服务器）增长过多时</span><span
lang=EN-US>,</span><span style='font-family:宋体'>负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包的流向都经过负载均衡器。当服务器节点过多时，大量的数据包都交汇在负载均衡器那，速度就会变慢！</span></p>

<h5><span lang=EN-US>I</span><span class=4><span lang=EN-US>P</span></span><span
class=4><span style='font-family:宋体'>隧道模式（</span><span lang=EN-US>VS-TUN</span></span><span
class=4><span style='font-family:宋体'>）</span></span></h5>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>原理：</span></b><span style='font-family:宋体'>首先要知道，互联网上的大多</span><span
lang=EN-US>Internet</span><span style='font-family:宋体'>服务的请求包很短小，而应答包通常很大。那么隧道模式就是，把客户端发来的数据包，封装一个新的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>头</span> <span
style='font-family:宋体'>标记</span><span lang=EN-US>(</span><span
style='font-family:宋体'>仅目的</span><span lang=EN-US>IP)</span><span
style='font-family:宋体'>发给</span><span lang=EN-US>RS,RS</span><span
style='font-family:宋体'>收到后</span><span lang=EN-US>,</span><span
style='font-family:宋体'>先把数据包的头解开</span><span lang=EN-US>,</span><span
style='font-family:宋体'>还原数据包</span><span lang=EN-US>,</span><span
style='font-family:宋体'>处理后</span><span lang=EN-US>,</span><span
style='font-family:宋体'>直接返回给客户端</span><span lang=EN-US>,</span><span
style='font-family:宋体'>不需要再经过负载均衡器</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>注意</span><span lang=EN-US>,</span><span
style='font-family:宋体'>由于</span><span lang=EN-US>RS</span><span
style='font-family:宋体'>需要对负</span> <span style='font-family:宋体'>载均衡器发过来的数据包进行还原</span><span
lang=EN-US>,</span><span style='font-family:宋体'>所以说必须支持</span><span lang=EN-US>IPTUNNEL</span><span
style='font-family:宋体'>协议</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>所以</span><span lang=EN-US>,</span><span
style='font-family:宋体'>在</span><span lang=EN-US>RS</span><span
style='font-family:宋体'>的内核中</span><span lang=EN-US>,</span><span
style='font-family:宋体'>必须编译支持</span><span lang=EN-US>IPTUNNEL</span><span
style='font-family:宋体'>这个选项</span></p>

<p class=MsoNoSpacing style='margin-left:31.6pt;text-indent:-31.6pt'><b><span
style='font-family:宋体'>优点：</span></b><span style='font-family:宋体'>负载均衡器只负责将请求包分发给后端节点服务器，而</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>将应答包直接发给用户。所以，减少了负载均衡器的大量数据流动，负载均衡器不再是系统的瓶颈，就能处理很巨大的请求量，这种方式，一台负载均衡器能够为很多</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>进行分发。而且跑在公网上就能进行不同地域的分发。</span></p>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>缺点：</span></b><span style='font-family:宋体'>隧道模式的</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>节点需要合法</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>，这种方式需要所有的服务器支持”</span><span lang=EN-US>IP Tunneling</span><span
style='font-family:宋体'>”</span><span lang=EN-US>(IP Encapsulation)</span><span
style='font-family:宋体'>协议，服务器可能只局限在部分</span><span lang=EN-US>Linux</span><span
style='font-family:宋体'>系统上。</span></p>

<h5><span style='font-family:宋体'>直接路由模式（</span><span lang=EN-US>VS-DR</span><span
style='font-family:宋体'>）</span></h5>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>原理：</span></b><span style='font-family:宋体'>负载均衡器和</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>都使用同一个</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>对外服务</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>但只有</span><span lang=EN-US>DR</span><span
style='font-family:宋体'>对</span><span lang=EN-US>ARP</span><span
style='font-family:宋体'>请求进行响应</span><span lang=EN-US>,</span><span
style='font-family:宋体'>所有</span><span lang=EN-US>RS</span><span
style='font-family:宋体'>对本身这个</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>的</span><span lang=EN-US>ARP</span><span
style='font-family:宋体'>请求保持静默</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>也就是说</span><span lang=EN-US>,</span><span
style='font-family:宋体'>网关会把对这个服务</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>的请求全部定向给</span><span lang=EN-US>DR,</span><span
style='font-family:宋体'>而</span><span lang=EN-US>DR</span><span
style='font-family:宋体'>收到数据包后根据调度算法</span><span lang=EN-US>,</span><span
style='font-family:宋体'>找出对应的</span><span lang=EN-US>RS,</span><span
style='font-family:宋体'>把目的</span><span lang=EN-US>MAC</span><span
style='font-family:宋体'>地址改为</span><span lang=EN-US>RS</span><span
style='font-family:宋体'>的</span><span lang=EN-US>MAC</span><span
style='font-family:宋体'>（因为</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>一致）并将请求分发给这台</span><span lang=EN-US>RS</span><span
style='font-family:"MS Mincho"'>&#65377;</span><span style='font-family:宋体'>这时</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>收到这个数据包</span><span
lang=EN-US>,</span><span style='font-family:宋体'>处理完成之后，由于</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>一致，可以直接将数据返给客户，则等于直接从客户端收到这个数据包无异</span><span
lang=EN-US>,</span><span style='font-family:宋体'>处理后直接返回给客户</span> <span
style='font-family:宋体'>端</span><span style='font-family:"MS Mincho"'>&#65377;</span><span
style='font-family:宋体'>由于负载均衡</span><span style='font-family:宋体'>器要对二层包头进行改换</span><span
lang=EN-US>,</span><span style='font-family:宋体'>所以负载均衡器和</span><span
lang=EN-US>RS</span><span style='font-family:宋体'>之间必须在一个广播域</span><span
lang=EN-US>,</span><span style='font-family:宋体'>也可以简单的理解为在同一台交换机上</span><span
style='font-family:"MS Mincho"'>&#65377;</span></p>

<p class=MsoNoSpacing style='margin-left:31.0pt;text-indent:-31.0pt'><b><span
style='font-family:宋体'>优点：</span></b><span style='font-family:宋体'>和</span><span
lang=EN-US>TUN</span><span style='font-family:宋体'>（隧道模式）一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与</span><span
lang=EN-US>VS-TUN</span><span style='font-family:宋体'>相比，</span><span
lang=EN-US>VS-DR</span><span style='font-family:宋体'>这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器。</span></p>

<p class=MsoNoSpacing style='margin-left:31.6pt;text-indent:-31.6pt'><b><span
style='font-family:宋体'>缺点：</span></b><span style='font-family:宋体'>（不能说缺点，只能说是不足）要求负载均衡器的网卡必须与物理网卡在一个物理段上。</span></p>

<h3><a name="_Toc33272376"><span lang=EN-US>2.1.3 </span></a><span
style='font-family:宋体'>调度算法</span></h3>

<h5><span lang=EN-US>1</span><span style='font-family:宋体'>、静态调度</span></h5>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp; &nbsp; &nbsp; </span><span
style='font-family:宋体'>①</span><span lang=EN-US>rr</span><span
style='font-family:宋体'>（</span><span lang=EN-US>Round Robin</span><span
style='font-family:宋体'>）</span><span lang=EN-US>:</span><span style='font-family:
宋体'>轮询调度，轮叫调度</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp; &nbsp; &nbsp; </span><span
style='font-family:宋体'>轮询调度算法的原理是每一次把来自用户的请求轮流分配给内部中的服务器，从</span><span
lang=EN-US>1</span><span style='font-family:宋体'>开始，直到</span><span lang=EN-US>N(</span><span
style='font-family:宋体'>内部服务器个数</span><span lang=EN-US>)</span><span
style='font-family:宋体'>，然后重新开始循环。算法的优点是其简洁性，它无需记录当前所有连接的状态，所以它是一种无状态调度。【提示：这里是不考虑每台服务器的处理能力】</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp; &nbsp; &nbsp;</span><span
style='font-family:宋体'>②</span><span lang=EN-US>wrr</span><span
style='font-family:宋体'>：</span><span lang=EN-US>weight,</span><span
style='font-family:宋体'>加权（以权重之间的比例实现在各主机之间进行调度）</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-size:12.0pt'>&nbsp; &nbsp;
&nbsp;</span><span style='font-size:12.0pt;font-family:宋体'>由于每台服务器的配置、安装的业务应用等不同，其处理能力会不一样。所以，我们根据服务器的不同处理能力，给每个服务器分配不同的权值，使其能够接受相应权值数的服务请求。</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span style='font-family:
宋体'>③</span><span lang=EN-US>sh:source hashing,</span><span style='font-family:
宋体'>源地址散列。主要实现会话绑定，能够将此前建立的</span><span lang=EN-US>session</span><span
style='font-family:宋体'>信息保留了源地址散列调度算法正好与目标地址散列调度算法相反，它根据请求的源</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址，作为散列键（</span><span
lang=EN-US>Hash Key</span><span style='font-family:宋体'>）从静态分配的散列表找出对应的服务器，若该服务器是可用的并且没有超负荷，将请求发送到该服务器，否则返回空。它采用的散列函数与目标地址散列调</span>
<span style='font-family:宋体'>度算法的相同。它的算法流程与目标地址散列调度算法的基本相似，除了将请求的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址换成请求的源</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址，所以这里不一个一个叙述。</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span style='font-family:
宋体'>④</span><span lang=EN-US>dh:Destination hashing:</span><span
style='font-family:宋体'>目标地址散列。把同一个</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址的请求，发送给同一个</span><span lang=EN-US>server</span><span
style='font-family:宋体'>。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>目标地址散列调度算法也是针对目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址的负载均衡，它是一种静态映射算法，通过一个散列（</span><span
lang=EN-US>Hash</span><span style='font-family:宋体'>）函数将一个目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址映射到一台服务器。目标地址散列调度算法先根据请求的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址，作为散列键（</span><span
lang=EN-US>Hash Key</span><span style='font-family:宋体'>）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</span></p>

<h5><span lang=EN-US>2</span><span style='font-family:宋体'>、动态调度</span></h5>

<p class=MsoNoSpacing><span style='font-family:宋体'>①</span><span lang=EN-US>lc</span><span
style='font-family:宋体'>（</span><span lang=EN-US>Least-Connection</span><span
style='font-family:宋体'>）：最少连接</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>最少连接调度算法是把新的连接请求分配到当前连接数最小的服务器，最小连接调度是一种动态调度短算法，它通过服务器当前所活跃的连接数来估计服务器的负载均衡，调度器需要记录各个服务器已建立连接的数目，当一个请求被调度到某台服务器，其连接数加</span><span
lang=EN-US>1</span><span style='font-family:宋体'>，当连接中止或超时，其连接数减一，在系统实现时，我们也引入当服务器的权值为</span><span
lang=EN-US>0</span><span style='font-family:宋体'>时，表示该服务器不可用而不被调度。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>简单算法：</span><span
lang=EN-US>active*256+inactive(</span><span style='font-family:宋体'>谁的小，挑谁</span><span
lang=EN-US>)</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>②</span><span lang=EN-US>wlc(Weighted
Least-Connection Scheduling)</span><span style='font-family:宋体'>：加权最少连接。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>加权最小连接调度算法是最小连接调度的超集，各个服务器用相应的权值表示其处理性能。服务器的缺省权值为</span><span
lang=EN-US>1</span><span style='font-family:宋体'>，系统管理员可以动态地设置服务器的权限，加权最小连接调度在调度新连接时尽可能使服务器的已建立连接数和其权值成比例。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>简单算法：（</span><span
lang=EN-US>active*256+inactive</span><span style='font-family:宋体'>）</span><span
lang=EN-US>/weight</span><span style='font-family:宋体'>【（活动的连接数</span><span
lang=EN-US>+1</span><span style='font-family:宋体'>）</span><span lang=EN-US>/</span><span
style='font-family:宋体'>除以权重】（谁的小，挑谁）</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>③</span><span lang=EN-US>sed(Shortest
Expected Delay)</span><span style='font-family:宋体'>：最短期望延迟</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>基于</span><span lang=EN-US>wlc</span><span
style='font-family:宋体'>算法</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>简单算法：（</span><span
lang=EN-US>active+1)*256/weight </span><span style='font-family:宋体'>【（活动的连接数</span><span
lang=EN-US>+1</span><span style='font-family:宋体'>）</span><span lang=EN-US>*256/</span><span
style='font-family:宋体'>除以权重】</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>④</span><span lang=EN-US>nq</span><span
style='font-family:宋体'>（</span><span lang=EN-US>never queue</span><span
style='font-family:宋体'>）</span><span lang=EN-US>:</span><span style='font-family:
宋体'>永不排队（改进的</span><span lang=EN-US>sed</span><span style='font-family:宋体'>）</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>无需队列，如果有台</span><span
lang=EN-US>realserver</span><span style='font-family:宋体'>的连接数＝</span><span
lang=EN-US>0</span><span style='font-family:宋体'>就直接分配过去，不需要在进行</span><span
lang=EN-US>sed</span><span style='font-family:宋体'>运算。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>⑤</span><span lang=EN-US>LBLC</span><span
style='font-family:宋体'>（</span><span lang=EN-US>Locality-Based Least Connection</span><span
style='font-family:宋体'>）：基于局部性的最少连接</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>基于局部性的最少连接算法是针对请求报文的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址的负载均衡调度，目前主要用于</span><span
lang=EN-US>Cache</span><span style='font-family:宋体'>集群系统，因为</span><span
lang=EN-US>Cache</span><span style='font-family:宋体'>集群中客户请求报文的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址是变化的，这里假设任何后端服务器都可以处理任何请求，算法的设计目标在服务器的负载基本平衡的情况下，将相同的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址的请求调度到同一个台服务器，来提高各台服务器的访问局部性和主存</span><span
lang=EN-US>Cache</span><span style='font-family:宋体'>命中率，从而调整整个集群系统的处理能力。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>基于局部性的最少连接调度算法根据请求的目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址找出该目标</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址最近使用的</span><span
lang=EN-US>RealServer</span><span style='font-family:宋体'>，若该</span><span
lang=EN-US>Real Server</span><span style='font-family:宋体'>是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少链接”的原则选出一</span>
<span style='font-family:宋体'>个可用的服务器，将请求发送到该服务器。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>⑥</span><span lang=EN-US>LBLCR</span><span
style='font-family:宋体'>（</span><span lang=EN-US>Locality-Based Least
Connections withReplication</span><span style='font-family:宋体'>）：带复制的基于局部性最少链接</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp; &nbsp; &nbsp; </span><span
style='font-family:宋体'>带复制的基于局部性最少链接调度算法也是针对目标</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址的负载均衡，该算法根据请求的目标</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址找出该目标</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地</span> <span style='font-family:宋体'>址对应的服务器组，按“最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器；若服务器超载，则按“最小连接”原则从这个</span>
<span style='font-family:宋体'>集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，</span>
<span style='font-family:宋体'>以降低复制的程度。</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp; </span><span
style='font-family:宋体'>此文方案使用</span><span lang=EN-US>VS-DR+RR</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>官网</span><span
lang=EN-US>: <a href="http://zh.linuxvirtualserver.org/">http://zh.linuxvirtualserver.org/</a></span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>高可用</span><span
lang=EN-US>LVS</span><span style='font-family:宋体'>负载均衡集群体系结构</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>高可用性软件</span><span
lang=EN-US>Heartbeat</span><span style='font-family:宋体'>与</span><span
lang=EN-US>Keepalived</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<h2><a name="_Toc33272377"></a><a name="_Toc436141400"></a><a
name="_Toc435713711"><span lang=EN-US>2.2 </span></a><span style='font-family:
宋体'>高可用软件</span> <span lang=EN-US>Keepalived</span></h2>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>是一款优秀的实现高可用的软件，它运行在</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>之上，它的主要功能是实现真实机的故障隔离及负载均衡器间的失败切换</span><span lang=EN-US>(failover)</span><span
style='font-family:宋体'>。</span><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>是一个类似于</span><span lang=EN-US>Layer3,Layer4,Layer5</span><span
style='font-family:宋体'>交换机制的软件，也就是我们平时说的第三层、第四层和第五层交换。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>的作用是检测服务器的状态，如果有一台服务器死机，或工作出现故障，</span><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>将检测到，并将有故障的服务器从系统中剔除，当服务器工作正常后</span><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>自动将服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人</span> <span
style='font-family:宋体'>工做的只是修复故障的服务器。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US>Keepalived</span><span
style='font-family:宋体'>是一款优秀的</span><span lang=EN-US>HA</span><span
style='font-family:宋体'>软件，一般应于生产环境下的</span><span lang=EN-US>LVS</span><span
style='font-family:宋体'>、</span><span lang=EN-US>Nginx</span><span
style='font-family:宋体'>中，采用都是双机方案，以保证最前端负载均衡器的高可用性。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>此方案中，主要用作</span><span
lang=EN-US>RealServer</span><span style='font-family:宋体'>的健康状态检查以及</span><span
lang=EN-US>LoadBalance</span><span style='font-family:宋体'>主机和</span><span
lang=EN-US>BackUP</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>主机之间</span><span lang=EN-US>failover</span><span
style='font-family:宋体'>的实现</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>通过</span><span
lang=EN-US>LVS+Keepalived</span><span style='font-family:宋体'>能实现的功能：利用</span><span
lang=EN-US>LVS</span><span style='font-family:宋体'>控制器主备模式避免单点故障以及自动删除故障服务器结点并当它恢复后再自动添加到群集中。</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>官网</span><span
lang=EN-US>: <a href="http://www.keepalived.org">http://www.keepalived.org</a></span></p>

<h2><a name="_Toc33272378"></a><a name="_Toc436141401"></a><a
name="_Toc435713712"><span lang=EN-US>2.3 </span></a><span style='font-family:
宋体'>流媒体直播服务器</span><span lang=EN-US>SRS</span></h2>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span lang=EN-US>SRS</span><span
style='font-family:宋体'>是国内个人优秀的开源项目，最初开发</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>版本时，他参考了开源</span><span lang=EN-US>nginx+rtmp</span><span
style='font-family:宋体'>架构，商用的</span><span lang=EN-US>FMS</span><span
style='font-family:宋体'>等流媒体直播系统，以及</span><span lang=EN-US>cdn</span><span
style='font-family:宋体'>中直播系统常有的应用，所以</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>提供功能实用性比较高，而且版本一直不断更新，官网资料全面，文档有中英版，代码注释多。</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span lang=EN-US>SRS</span><span
style='font-family:宋体'>定位是运营级的互联网直播服务器集群，追求更好的概念完整性和最简单实现的代码，提供了丰富的接入方案将</span><span
lang=EN-US>RTMP</span><span style='font-family:宋体'>流接入</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>，包括推送</span><span lang=EN-US>RTMP</span><span
style='font-family:宋体'>到</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>、推送</span><span lang=EN-US>RTSP/UDP/FLV</span><span
style='font-family:宋体'>到</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>、拉取流到</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>。</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>还支持将接入的</span><span lang=EN-US>RTMP</span><span
style='font-family:宋体'>流进行各种变换，譬如将</span><span lang=EN-US>RTMP</span><span
style='font-family:宋体'>流转码、流截图、转发给其他服务器、转封装成</span><span lang=EN-US>HTTP-FLV</span><span
style='font-family:宋体'>流、转封装成</span><span lang=EN-US>HLS</span><span
style='font-family:宋体'>、转封装成</span><span lang=EN-US>HDS</span><span
style='font-family:宋体'>、录制成</span><span lang=EN-US>FLV</span><span
style='font-family:宋体'>。</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>包含支大规模集群如</span><span lang=EN-US>CDN</span><span
style='font-family:宋体'>业务的关键特性，譬如</span><span lang=EN-US>RTMP</span><span
style='font-family:宋体'>多级集群、</span><span lang=EN-US>VHOST</span><span
style='font-family:宋体'>虚拟服务器、无中断服务</span><span lang=EN-US>Reload</span><span
style='font-family:宋体'>、</span><span lang=EN-US>HTTP-FLV</span><span
style='font-family:宋体'>集群、</span><span lang=EN-US>Kafka</span><span
style='font-family:宋体'>对接。此外，</span><span lang=EN-US>SRS</span><span
style='font-family:宋体'>还提供丰富的应用接口，包括</span><span lang=EN-US>HTTP</span><span
style='font-family:宋体'>回调、安全策略</span><span lang=EN-US>Security</span><span
style='font-family:宋体'>、</span><span lang=EN-US>HTTP API</span><span
style='font-family:宋体'>接口、</span><span lang=EN-US>RTMP</span><span
style='font-family:宋体'>测速。</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span style='font-family:
宋体'>在此方案中，主要完成<span lang=EN-US>rtmp</span>直播流边缘缓冲功能</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span style='font-family:
宋体'>官网</span><span lang=EN-US>:</span><span lang=EN-US style='font-family:"Segoe UI",sans-serif;
color:#40485B;background:white'> </span><span lang=EN-US><a
href="https://github.com/ossrs/srs"><span style='font-family:"Segoe UI",sans-serif;
background:white'>https://github.com/ossrs/srs</span></a></span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span lang=EN-US>&nbsp;</span></p>

<h2><a name="_Toc33272379"></a><a name="_Toc436141402"></a><a
name="_Toc435713713"><span lang=EN-US>2.4 Web</span></a><span style='font-family:
宋体'>缓冲服务器</span><span lang=EN-US>Squid</span></h2>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp; </span><span
class=highlight><span lang=EN-US style='font-family:宋体'>Squid</span></span><span
lang=EN-US style='font-family:宋体'> cache</span><span style='font-family:宋体'>（简称为<span
class=highlight><span lang=EN-US>Squid</span></span>）是一个流行的自由软件（<span
lang=EN-US>GNU</span>通用公共许可证）的代理服务器和<span lang=EN-US>Web</span>缓存服务器。<span
class=highlight><span lang=EN-US>Squid</span></span>有广泛的用途，从作为网页服务器的前置<span
lang=EN-US>cache</span>服务器缓存相关请求来提高</span></p>

<p class=MsoNoSpacing style='text-indent:15.75pt'><span lang=EN-US
style='font-family:宋体'>Squid</span><span style='font-family:宋体'>是一种用来缓冲<span
lang=EN-US>Internet</span>数据的软件。它是这样实现其功能的，接受来自人们需要下载的目标（<span lang=EN-US>object</span>）的请求并适当地处理这些请求。也就是说，如果一个人想下载一<span
lang=EN-US>web</span>页面，他请求<span lang=EN-US>Squid</span>为他取得这个页面。<span
lang=EN-US>Squid</span>随之连接到远程服务器（比如：<span lang=EN-US>http</span>：<span
lang=EN-US>//squid.nlanr.net/</span>）并向这个页面发出请求。然后，<span lang=EN-US>Squid</span>显式地聚集数据到客户端机器，而且同时复制一份。当下一次有人需要同一页面时，<span
lang=EN-US>Squid</span>可以简单地从磁盘中读到它，那样数据迅即就会传输到客户机上。当前的<span lang=EN-US>Squid</span>可以处理<span
lang=EN-US>HTTP</span>，<span lang=EN-US>FTP</span>，<span lang=EN-US>GOPHER</span>，<span
lang=EN-US>SSL</span>和<span lang=EN-US>WAIS</span>等协议。但它不能处理如<span lang=EN-US>POP</span>，<span
lang=EN-US>NNTP</span>，<span lang=EN-US>RealAudio</span>以及其它类型的东西。 </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>&nbsp; </span><span
style='font-family:宋体'>在此方案中，主要完成<span lang=EN-US>http</span>点播边缘缓冲功能</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>&nbsp; </span><span
style='font-family:宋体'>官网<span lang=EN-US>:</span></span><span lang=EN-US> <a
href="http://www.squid-cache.org"><span style='font-family:宋体'>http://www.squid-cache.org</span></a></span></p>

<p class=MsoNoSpacing><span class=MsoHyperlink><span lang=EN-US
style='font-family:宋体'><span style='text-decoration:none'>&nbsp;</span></span></span></p>

<h2><a name="_Toc33272380"></a><a name="_Toc436141403"></a><a
name="_Toc435713714"><span lang=EN-US>2.5 </span></a><span style='font-family:
宋体'>负载均衡</span><span style='font-family:宋体'>应用</span></h2>

<h3><a name="_Toc436141405"></a><a name="_Toc435713716"></a><a
name="_Toc33272381"></a><a name="_Toc436141404"></a><a name="_Toc435713715"><span
lang=EN-US>2.5.1 </span></a><span style='font-family:宋体'>系统环境</span></h3>

<p class=MsoNoSpacing><span style='font-family:宋体'>系统平台：</span><span
lang=EN-US>VMware&nbsp; centos 7</span></p>

<p class=MsoNoSpacing><span lang=EN-US>LVS</span><span style='font-family:宋体'>版本：</span><span
lang=EN-US>ipvsadm-1.27</span></p>

<p class=MsoNoSpacing><span lang=EN-US>keepalived</span><span style='font-family:
宋体'>版本：</span><span lang=EN-US>keepalived-1.2.19</span></p>

<p class=MsoNoSpacing><span lang=EN-US>srs</span><span style='font-family:宋体'>版本</span><span
lang=EN-US>: srs-2.0a2</span></p>

<p class=MsoNoSpacing><span lang=EN-US>squid</span><span style='font-family:
宋体'>版本</span><span lang=EN-US>: squid-3.5.11.tar.gz</span></p>

<h3><a name="_Toc33272382"><span lang=EN-US>2.5.2 </span></a><span
style='font-family:宋体'>配置真实主机</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>在真实主机</span><span
lang=EN-US>192.168.254.129</span><span style='font-family:宋体'>与</span><span
lang=EN-US>192.168.254.130</span><span style='font-family:宋体'>配置与安装点播缓冲服务</span><span
lang=EN-US>squid</span><span style='font-family:宋体'>，与直播边缘服务</span><span
lang=EN-US>srs</span></p>

<h4><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) </span><span style='font-family:宋体'>安装与配置直播流媒体服务器</span><span
lang=EN-US>simple rtmp server(srs)</span></h4>

<p class=MsoNormal><span lang=EN-US>1.</span><span style='font-family:宋体'>官方下载</span><span
lang=EN-US style='font-family:"Segoe UI",sans-serif;color:#40485B;background:
white'>&nbsp;</span><span lang=EN-US><a href="https://github.com/ossrs/srs"><span
style='font-family:"Segoe UI",sans-serif;color:#005980;background:white'>https://github.com/ossrs/srs</span></a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2.</span><span style='font-size:12.0pt;
font-family:宋体'>编译与安装</span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:66.0pt'><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'>./configure &amp;&amp; make
&amp;&amp; make install</span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:66.0pt'><span
style='font-size:12.0pt;font-family:宋体'>默认安装在<span lang=EN-US>/usr/local/srs</span></span></p>

<p class=MsoNormal><span lang=EN-US>3.</span><span style='font-family:宋体'>配置</span></p>

<p class=MsoNormal style='text-indent:57.75pt'><span style='font-family:宋体'>修改边缘服务器配置</span><span
lang=EN-US>conf/edge.conf</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt;text-indent:0cm'><span
lang=EN-US>{</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
1935;</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>max_connections&nbsp;&nbsp;&nbsp;&nbsp;
1000;</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
objs/edge.pid;</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>srs_log_file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
./objs/edge.log;</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>vhost
__defaultVhost__ {</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remote;</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
origin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
192.168.111.99:1935; #</span><span style='font-family:宋体'>源服务器地址与端口</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt;text-indent:0cm'><span
lang=EN-US>}</span></p>

<p class=MsoNormal><span lang=EN-US>4.</span><span style='font-family:宋体'>启动</span></p>

<p class=MsoListParagraph style='margin-left:54.7pt;text-indent:5.25pt'><span
lang=EN-US>./objs/srs&nbsp; -c conf/edge.conf</span></p>

<h4><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>安装与配置</span><span lang=EN-US>http</span><span
style='font-family:宋体'>缓冲服务器</span><span lang=EN-US>squid</span></h4>

<p class=MsoNormal><span lang=EN-US>1.</span><span style='font-family:宋体'>官方下载</span><span
lang=EN-US><a href="http://www.squid-cache.org/Versions/">http://www.squid-cache.org/Versions/</a></span></p>

<p class=MsoNormal><span lang=EN-US>2.</span><span style='font-family:宋体'>编译与安装</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt;text-indent:0cm'><span
lang=EN-US>&nbsp; ./configure&nbsp; &amp;&amp; make &amp;&amp; make install</span></p>

<p class=MsoListParagraph style='margin-left:54.75pt;text-indent:0cm'><span
lang=EN-US>&nbsp; </span><span style='font-family:宋体'>默认安装在</span><span
lang=EN-US>/usr/local/squid</span></p>

<p class=MsoNormal><span lang=EN-US>3.</span><span style='font-family:宋体'>配置</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span style='font-family:宋体'>将默认</span><span
lang=EN-US>squid.conf</span><span style='font-family:宋体'>备份，修改</span><span
lang=EN-US>/usr/local/squid/etc/squid.conf</span><span style='font-family:宋体'>为如下内容</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>http_port &nbsp;80
&nbsp;accel &nbsp;vhost&nbsp; #squid</span><span style='font-family:宋体'>监听端口</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>http_access
allow all&nbsp; #</span><span style='font-family:宋体'>访问控制</span></p>

<p class=MsoListParagraph style='margin-left:15.65pt;text-indent:0cm'><span
lang=EN-US>cache_peer 192.168.111.99 parent 8080 0 no-query originserver #</span><span
style='font-family:宋体'>定义源服务器端口与地址</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>cache_mem 64 MB&nbsp;
#</span><span style='font-family:宋体'>缓存占内存大小</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>maximum_object_size
4 MB #</span><span style='font-family:宋体'>最大缓存块</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>minimum_object_size
0 KB&nbsp; #</span><span style='font-family:宋体'>最小缓存块</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>maximum_object_size_in_memory
4096 KB #</span><span style='font-family:宋体;color:black;background:white'>内存中</span><span
lang=EN-US style='color:black;background:white'>cache</span><span
style='font-family:宋体;color:black;background:white'>的最大文件大小</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>cache_dir aufs
/var/spool/squid 100 16 256 #</span><span style='font-family:宋体'>定义缓存目录</span></p>

<p class=MsoNormal style='text-indent:89.25pt'><span lang=EN-US>#ausf:</span><span
style='font-family:宋体'>缓存数据的存储格式</span></p>

<p class=MsoNormal style='text-indent:89.25pt'><span lang=EN-US>#/var/spool/squid
</span><span style='font-family:宋体'>缓存目录</span></p>

<p class=MsoNormal style='text-indent:89.25pt'><span lang=EN-US>#100 : </span><span
style='font-family:宋体'>缓存目录占磁盘空间大小（</span><span lang=EN-US>M</span><span
style='font-family:宋体'>）</span></p>

<p class=MsoNormal style='text-indent:89.25pt'><span lang=EN-US>#16 </span><span
style='font-family:宋体'>：缓存空间一级子目录个数</span></p>

<p class=MsoNormal style='text-indent:89.25pt'><span lang=EN-US>#256 </span><span
style='font-family:宋体'>：缓存空间二级子目录个数</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>access_log
/var/log/squid/access.log combined #</span><span style='font-family:宋体'>日志存储方式</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>cache_log
/var/log/squid/cache.log&nbsp;&nbsp;&nbsp; #</span><span style='font-family:
宋体'>访问日志存放的文件</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>logfile_rotate
60&nbsp; #</span><span style='font-family:宋体'>日志转换</span> <span
style='font-family:宋体'>执行</span><span lang=EN-US>squid -k rotate</span></p>

<p class=MsoNormal style='margin-left:15.75pt'><span lang=EN-US>cache_swap_high
95&nbsp; #</span><span style='font-family:宋体'>这两行是</span><span lang=EN-US>,</span><span
style='font-family:宋体'>当缓存目录空间达到</span><span lang=EN-US>95%</span><span
style='font-family:宋体'>的时候</span><span lang=EN-US>,</span><span
style='font-family:宋体'>删</span><span lang=EN-US>&nbsp;&nbsp;<br>
cache_swap_low 90&nbsp; #</span><span style='font-family:宋体'>除缓存到</span><span
lang=EN-US>90%</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNormal><span lang=EN-US>3.</span><span style='font-family:宋体'>启动</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>/usr/local/squid/sbin/squid&nbsp;
-k&nbsp; parse&nbsp; </span><span style='font-family:宋体'>检查配置是否有问</span> </p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>/usr/local/squid/sbin/squid
&nbsp;-z&nbsp; </span><span style='font-family:宋体'>创建缓冲目录</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>/usr/local/squid/sbin/squid&nbsp;&nbsp;
</span><span style='font-family:宋体'>启动</span><span lang=EN-US>squid</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; </span><span style='font-family:
宋体'>如果执行命令时提示文件或目录没有权限，可以使用</span><span lang=EN-US>chmod&nbsp; 777 </span><span
style='font-family:宋体'>目录</span> <span lang=EN-US>CR&nbsp; </span><span
style='font-family:宋体'>修改权限</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span style='font-family:宋体'>成功启动之后，可以</span><span
lang=EN-US>curl</span><span style='font-family:宋体'>命令测试是否能成功</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<img border=0 width=554 height=304 id="图片 6"
src="live_vod_cdn.files/image009.png"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>结果显示成功连接到</span><span
lang=EN-US>192.168.111.99:8080 nginx Web</span><span style='font-family:宋体'>服务器上。</span></p>

<h3><a name="_Toc33272383"></a><a name="_Toc436141406"></a><a
name="_Toc435713717"><span lang=EN-US>2.5.3 </span></a><span style='font-family:
宋体'>配置</span><span lang=EN-US>lvs</span><span style='font-family:宋体'>与</span><span
lang=EN-US>keepalived</span></h3>

<p class=MsoNormal align=left style='text-align:left;text-indent:21.0pt'><span
style='font-family:宋体'>如果需要双机热备可以在主备机使用</span><span lang=EN-US>lvs+keepalived</span><span
style='font-family:宋体'>，否则只在主机上配置</span><span lang=EN-US>lvs, </span><span
style='font-family:宋体'>不使用双机热备时，存在单点故障。</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US>(一)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='font-family:宋体'>两台</span><span lang=EN-US>LVS Server</span><span
style='font-family:宋体'>上安装</span><span lang=EN-US>lvs</span><span
style='font-family:宋体'>、</span><span lang=EN-US>keepalived</span><span
style='font-family:宋体'>软件</span></h4>

<p class=MsoNoSpacing><span style='font-family:宋体'>注意</span><span lang=EN-US>: </span><span
style='font-family:宋体'>测试环境在</span><span lang=EN-US>vmware </span><span
style='font-family:宋体'>上安装时</span><span lang=EN-US>centos 7 </span><span
style='font-family:宋体'>后系统自动安装了</span><span lang=EN-US>lvs,</span><span
style='font-family:宋体'>如果没有安装，请按</span><span lang=EN-US> lvs install</span><span
style='font-family:宋体'>安装步骤</span></p>

<p class=MsoNoSpacing><span lang=EN-US>lvs install -------------</span></p>

<p class=MsoNoSpacing style='margin-left:5.25pt;text-indent:-5.25pt'><span
lang=EN-US>[root@LVS-MASTER~]#wget http://www.linuxvirtualserver.org/software/kernel-2.6/ipvsadm-1.24.tar.gz</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# ln -s
/usr/src/kernels/2.6.18-194.el5-i686/&nbsp; /usr/src/linux/</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# tar zxvf
ipvsadm-1.24.tar.gz</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# cd ipvsadm-1.24</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ipvsadm-1.24]# make
&amp;&amp; make install</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>不需要双机热备不安装</span><span
lang=EN-US>keepalived</span></p>

<p class=MsoNoSpacing><span lang=EN-US>Keepalived install -------------</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# wget
http://www.keepalived.org/software/keepalived-1.2.19.tar.gz</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# tar zxvf
keepalived-1.2.19.tar.gz</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER ~]# cd keepalived-1.2.19</span></p>

<p class=MsoNoSpacing><span lang=EN-US>[root@LVS-MASTER keepalived-1.2.19]#
./configure &amp;&amp; make &amp;&amp; make install</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US>(二)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='font-family:宋体'>不需要双机热备</span><span lang=EN-US>,</span><span
style='font-family:宋体'>只单机安装</span><span lang=EN-US>lvs</span></h4>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp; &nbsp;</span><span
style='font-family:宋体'>如果使用双机热备，请跳至第三步</span><span lang=EN-US>keepalived</span><span
style='font-family:宋体'>的配置虚拟地址，网卡物理设备名为</span><span lang=EN-US>eno16777736&nbsp;
</span><span style='font-family:宋体'>虚拟地址为</span><span lang=EN-US>192.168.254.120</span><span
style='font-family:宋体'>：</span></p>

<p class=MsoNormal><span lang=EN-US>ifconfig eno16777736:0 192.168.254.120
broadcast 192.168.254.120 netmask 255.255.255.255 up &nbsp;&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:宋体'>配置成功后，使用</span><span
lang=EN-US>ifconfig</span><span style='font-family:宋体'>查看是否成功</span></p>

<p class=MsoNormal style='margin-left:21.0pt;text-indent:-21.0pt'><span
lang=EN-US><img border=0 width=554 height=196 id="图片 3"
src="live_vod_cdn.files/image010.jpg"></span><span style='font-family:宋体'>添加虚拟主机路由，使用如下命令添加路由：</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>route &nbsp;add &nbsp;-host
&nbsp;192.168.254.120 &nbsp;dev &nbsp;eno16777736:0</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>使用</span><span
lang=EN-US>route</span><span style='font-family:宋体'>查看路由表是否成功</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=554 height=125 id="图片 4"
src="live_vod_cdn.files/image011.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:宋体'>映射虚拟地址与真实服务器地址，如果不使用双机热备，需要使用</span><span lang=EN-US>ipvsadm</span><span
style='font-family:宋体'>命令配置虚拟地址与真实服务器地址映射。新建</span><span lang=EN-US>lvs.sh</span><span
style='font-family:宋体'>脚本文件，把这些命令放入</span><span lang=EN-US>lvs.sh</span><span
style='font-family:宋体'>脚本文件，然后执行</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;
SNS_VIP=192.168.254.120&nbsp; #</span><span style='font-family:宋体'>虚拟地址</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>SNS_RIP1=192.168.254.129&nbsp;
#</span><span style='font-family:宋体'>真实服务器地址</span><span lang=EN-US>1</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>SNS_RIP2=192.168.254.130&nbsp;
#</span><span style='font-family:宋体'>真实服务器地址</span><span lang=EN-US>2</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>#</span><span
style='font-family:宋体'>映射</span><span lang=EN-US>80</span><span
style='font-family:宋体'>端口</span></p>

<p class=MsoNormal style='text-indent:26.25pt'><span lang=EN-US>ipvsadm -A -t
$SNS_VIP:80 -s rr -p 120</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; ipvsadm -a -t
$SNS_VIP:80 -r $SNS_RIP1:80 -g -w 1</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; ipvsadm -a -t
$SNS_VIP:80 -r $SNS_RIP2:80 -g -w 1</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体'>映身</span><span lang=EN-US>1935</span><span
style='font-family:宋体'>端口</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; ipvsadm -A -t
$SNS_VIP:1935 -s rr -p 120</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; &nbsp;&nbsp;&nbsp;ipvsadm -a -t
$SNS_VIP:1935 -r $SNS_RIP1:1935 -g -w 1</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; ipvsadm -a -t
$SNS_VIP:1935 -r $SNS_RIP2:1935 -g -w 1</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US>(三)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-US>keepalived</span><span style='font-family:宋体'>的配置</span></h4>

<p class=MsoNormal><span style='font-family:宋体'>成功安装</span><span lang=EN-US>keepalived</span><span
style='font-family:宋体'>后，修改配置文件</span><span lang=EN-US>/etc/keepalived/keepalived.conf,
</span><span style='font-family:宋体'>内容如下</span></p>

<p class=MsoNoSpacing><span lang=EN-US>###################&nbsp; MASTER
###################</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;!
Configuration File for keepalived</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>global_defs
{</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
notification_email {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;
root@test.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置报警邮件地址，可以设置多个，每行一个。</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;
test@qq.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>需开启本机的<span lang=EN-US>sendmail</span>服务</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
notification_email_from
keepalived@localhost&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>设置邮件的发送地址</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
smtp_server
127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置<span lang=EN-US>smtp server</span>地址</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
smtp_connect_timeout
30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置连接<span lang=EN-US>smtp
server</span>的超时时间</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
router_id
LVS_DEVEL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span
style='font-family:宋体;color:black'>表示运行<span lang=EN-US>keepalived</span>服务器的一个标识。发邮件时显示在邮件主题的信息</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>vrrp_instance
VI_1 {</span></p>

<p class=MsoNoSpacing style='margin-left:157.5pt;text-indent:-157.5pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp; state
MASTER&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span
style='font-family:宋体;color:black'>指定<span lang=EN-US>keepalived</span>的角色，<span
lang=EN-US>MASTER</span>表示此主机是主服务器，<span lang=EN-US>BACKUP</span>表示此主机是备用服务器</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
interface eno16777736&nbsp;&nbsp;&nbsp;&nbsp; #</span><span style='font-family:
宋体;color:black'>指定<span lang=EN-US>HA</span>监测网络的接口</span></p>

<p class=MsoNoSpacing style='margin-left:157.5pt;text-indent:-157.5pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
virtual_router_id 51&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>虚拟路由标识，这个标识是一个数字，同一个<span lang=EN-US>vrrp</span>实例使用唯一的标识。即同一<span
lang=EN-US>vrrp_instance</span>下，<span lang=EN-US>MASTER</span>和<span
lang=EN-US>BACKUP</span>必须是一致的</span></p>

<p class=MsoNoSpacing style='margin-left:162.75pt;text-indent:-162.75pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp; priority
100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>定义优先级，数字越大，优先级越高，在同一个<span lang=EN-US>vrrp_instance</span>下，<span
lang=EN-US>MASTER</span>的优先级必须大于<span lang=EN-US>BACKUP</span>的优先级</span></p>

<p class=MsoNoSpacing style='margin-left:157.5pt;text-indent:-157.5pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp; advert_int
1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设定<span lang=EN-US>MASTER</span>与<span
lang=EN-US>BACKUP</span>负载均衡器之间同步检查的时间间隔，单位是秒</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
authentication {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>设置验证类型和密码</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;auth_type
PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span style='font-family:
宋体;color:black'>设置验证类型，主要有<span lang=EN-US>PASS</span>和<span lang=EN-US>AH</span>两种</span></p>

<p class=MsoNoSpacing style='margin-left:157.5pt;text-indent:-157.5pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
auth_pass 1111&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>设置验证密码，在同一个<span lang=EN-US>vrrp_instance</span>下，<span
lang=EN-US>MASTER</span>与<span lang=EN-US>BACKUP</span>必须使用相同的密码才能正常通信</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US
style='font-family:宋体;color:black'>virtual_ipaddress {&nbsp; </span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US
style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>设置虚拟<span lang=EN-US>IP</span>地址，可以设置多个虚拟<span
lang=EN-US>IP</span>地址，每行一个</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
192.168.254.120</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>virtual_server
192.168.254.120 80 {&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置虚拟服务器，需要指定虚拟<span
lang=EN-US>IP</span>地址和服务端口，<span lang=EN-US>IP</span>与端口之间用空格隔开</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
delay_loop
6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置运行情况检查时间，单位是秒</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_algo
rr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置负载调度算法，这里设置为<span
lang=EN-US>rr</span>，即轮询算法</span></p>

<p class=MsoNoSpacing style='margin-left:183.75pt;text-indent:-183.75pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp; lb_kind
DR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>设置<span lang=EN-US>LVS</span>实现负载均衡的机制，有<span
lang=EN-US>NAT</span>、<span lang=EN-US>TUN</span>、<span lang=EN-US>DR</span>三个模式可选</span></p>

<p class=MsoNoSpacing style='margin-left:189.0pt;text-indent:-189.0pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
persistence_timeout 50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>会话保持时间，单位是秒。这个选项对动态网页是非常有用的，为集群系统中的<span
lang=EN-US>session</span>共享提供了一个很好的解决方案。</span></p>

<p class=MsoNoSpacing style='margin-left:189.0pt;text-indent:-189.0pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>有了这个会话保持功能，用户的请求会被一直分发到某个服务节点，直到超过这个会话的保持时间。</span></p>

<p class=MsoNoSpacing style='margin-left:189.0pt;text-indent:-189.0pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>需要注意的是，这个会话保持时间是最大无响应超时时间，也就是说，用户在操作动态页面时，如果<span
lang=EN-US>50</span>秒内没有执行任何操作，</span></p>

<p class=MsoNoSpacing style='margin-left:189.0pt;text-indent:-189.0pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>那么接下来的操作会被分发到另外的节点，但是如果用户一直在操作动态页面，则不受<span
lang=EN-US>50</span>秒的时间限制</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
protocol
TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>指定转发协议类型，有<span lang=EN-US>TCP</span>和<span
lang=EN-US>UDP</span>两种</span></p>

<p class=MsoNoSpacing style='margin-left:199.5pt;text-indent:-178.5pt'><span
lang=EN-US style='font-family:宋体;color:black'>real_server 192.168.254.129 80 {
#</span><span style='font-family:宋体;color:black'>配置服务节点<span lang=EN-US>1</span>，需要指定<span
lang=EN-US>real server</span>的真实<span lang=EN-US>IP</span>地址和端口，<span
lang=EN-US>IP</span>与端口之间用空格隔开</span></p>

<p class=MsoNoSpacing style='margin-left:183.75pt;text-indent:-183.75pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>配置服务节点的权值，权值大小用数字表示，数字越大，权值越高，设置权值大小可以为不同性能的服务器</span></p>

<p class=MsoNoSpacing style='margin-left:189.0pt;text-indent:-189.0pt'><span
lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='font-family:宋体;color:black'>分配不同的负载，可以为性能高的服务器设置较高的权值，而为性能较低的服务器设置相对较低的权值，这样才能合理地利用和分配系统资源</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#realserver</span><span style='font-family:宋体;color:black'>的状态检测设置部分，单位是秒</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>表示<span lang=EN-US>3</span>秒无响应超时</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='font-family:宋体;color:black'>表示重试次数</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3&nbsp;&nbsp;&nbsp; #</span><span style='font-family:宋体;
color:black'>表示重试间隔</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.130 80 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>virtual_server
192.168.254.120 1935 {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
delay_loop
6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_algo
rr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US
style='font-family:宋体;color:black'>lb_kind
DR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span lang=EN-US
style='font-family:宋体;color:black'>persistence_timeout
50&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
protocol
TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>real_server
192.168.254.129 1935 {&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3&nbsp;&nbsp; </span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 1935</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.130 1935 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 1935</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>####################&nbsp;BACKUP
###################</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>!
Configuration File for keepalived</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>global_defs
{</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
notification_email {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;
root@linux.tang.chao</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;
mchina_tang@qq.com</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
notification_email_from Alexandre.Cassen@firewall.loc</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
smtp_server 127.0.0.1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
smtp_connect_timeout 30</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;
router_id LVS_DEVEL</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>vrrp_instance
VI_1 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
state BACKUP</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
interface eno16777736</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
virtual_router_id 51</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
priority 99</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
advert_int 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
authentication {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
auth_type PASS</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
auth_pass 1111</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
virtual_ipaddress {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
192.168.254.120</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>#</span><span
style='font-family:宋体;color:black'>映射<span lang=EN-US>80</span>端口</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>virtual_server
192.168.254.120 80 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
delay_loop 6</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_algo rr</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_kind DR</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
persistence_timeout 50</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
protocol TCP</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.129 80 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.130 80 {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>#</span><span
style='font-family:宋体;color:black'>映射<span lang=EN-US>1935</span>端口</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>virtual_server
192.168.254.120 &nbsp;1935{</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
delay_loop 6</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_algo rr</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
lb_kind DR</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
persistence_timeout 50</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
protocol TCP</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.129 1935{</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
real_server 192.168.254.130 1935{</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
weight 1</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TCP_CHECK {</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_timeout 10</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nb_get_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
delay_before_retry 3</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
connect_port 80</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>&nbsp;&nbsp;&nbsp;
}</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体;color:black'>}</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US>(四)<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
style='font-family:宋体'>绑定</span><span lang=EN-US>VIP</span><span
style='font-family:宋体'>地址，并设定</span><span lang=EN-US>arp</span><span
style='font-family:宋体'>抑制</span></h4>

<p class=MsoNormal><span style='font-family:宋体'>这两台真实主机上，新建</span><span
lang=EN-US>rsrun.sh</span><span style='font-family:宋体'>脚本文件，输入如下这些内容，然后执行</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;
VIP=192.168.254.120&nbsp;&nbsp; #</span><span style='font-family:宋体'>虚拟地址</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>ifconfig lo:0
$VIP broadcast $VIP netmask 255.255.255.255 up&nbsp; #</span><span
style='font-family:宋体'>添加虚拟地址</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>route add -host
$VIP dev lo:0&nbsp; #</span><span style='font-family:宋体'>添加路由</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>echo
&quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore #</span><span
style='font-family:宋体'>实现禁止响应对</span><span lang=EN-US>VIP</span><span
style='font-family:宋体'>的</span><span lang=EN-US>ARP</span><span
style='font-family:宋体'>请求</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>echo
&quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>echo
&quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore&nbsp; #</span><span
style='font-family:宋体'>实现禁止响应对</span><span lang=EN-US>VIP</span><span
style='font-family:宋体'>的</span><span lang=EN-US>ARP</span><span
style='font-family:宋体'>请求</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>echo &quot;2&quot;
&gt;/proc/sys/net/ipv4/conf/all/arp_announce</span></p>

<p class=MsoNormal style='text-indent:36.75pt'><span lang=EN-US>sysctl Cp</span></p>

<p class=MsoNormal><span style='font-family:宋体'>运行脚本：</span><span lang=EN-US>./rsrun.sh</span></p>

<p class=MsoNormal><span style='font-family:宋体'>运行脚本之后使有</span><span
lang=EN-US>ifconfig </span><span style='font-family:宋体'>查看是否成功配置</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; <img border=0 width=554 height=98
id="图片 14" src="live_vod_cdn.files/image012.jpg"></span></p>

<p class=MsoNormal><span style='font-family:宋体'>使用</span><span lang=EN-US>route</span><span
style='font-family:宋体'>查看路由表</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>&nbsp;</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US
style='font-size:10.5pt;line-height:156%'>(五)<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:宋体'>启动负载均衡高可用集群</span></h4>

<p class=MsoNoSpacing><span style='font-family:宋体'>分别在主备机上执行</span><span
lang=EN-US>systemctl start keepalived.service</span><span style='font-family:
宋体'>启动</span><span lang=EN-US>keepalived</span><span style='font-family:宋体'>就可实现负载均衡及高可用集群了；</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>&nbsp;systemctl
start keepalived.service</span></p>

<p class=MsoNoSpacing><span lang=EN-US style='font-family:宋体'>&nbsp;ipvsadm -L</span><span
lang=EN-US style='font-family:宋体'><br>
</span><span lang=EN-US><img border=0 width=554 height=193 id="图片 5"
src="live_vod_cdn.files/image013.jpg"></span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>查看日志</span><span lang=EN-US>/var/log/messages</span></p>

<p class=MsoNoSpacing style='text-indent:5.25pt'><span lang=EN-US>tail -n 30&nbsp;
/var/log/messages</span></p>

<h4 style='margin-left:36.0pt;text-indent:-36.0pt'><span lang=EN-US
style='font-family:宋体'>(六)<span style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-family:宋体'>测试</span></h4>

<p class=MsoNoSpacing><span style='font-family:宋体'>接下来做高可用性测试</span><span
lang=EN-US>&amp;</span><span style='font-family:宋体'>故障切换测试</span></p>

<p class=MsoNoSpacing><b><span lang=EN-US>1.</span></b><b><span
style='font-family:宋体'>高可用性测试</span></b></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>模拟故障，将</span><span
lang=EN-US>LVS-MASTER</span><span style='font-family:宋体'>上的</span><span
lang=EN-US>keepalived</span><span style='font-family:宋体'>服务停掉，然后观察</span><span
lang=EN-US>LVS-BACKUP</span><span style='font-family:宋体'>上的日志，信息如下</span></p>

<p class=MsoNoSpacing style='text-indent:5.25pt'><span lang=EN-US>tail -f
/var/log/messages</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=115
id="图片 1" src="live_vod_cdn.files/image014.jpg"></span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>从日志中可知，主机出现故障后，备机立刻检测到，此时备机变为</span><span
lang=EN-US>MASTER</span><span style='font-family:宋体'>角色，并且接管了主机的虚拟</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>资源，最后将虚拟</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>绑定在</span><span lang=EN-US>etho</span><span
style='font-family:宋体'>设备上。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>将</span><span lang=EN-US>LVS-MASTER&nbsp;</span><span
style='font-family:宋体'>上的</span><span lang=EN-US>keepalived</span><span
style='font-family:宋体'>服务开启后，</span><span lang=EN-US>LVS-BACKUP</span><span
style='font-family:宋体'>的日志状态。</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=553 height=71
id="图片 10" src="live_vod_cdn.files/image015.jpg"></span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>从日志可知，备机在检测到主机重新恢复正常后，释放了虚拟</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>资源重新成为</span><span lang=EN-US>BACKUP</span><span
style='font-family:宋体'>角色</span></p>

<p class=MsoNoSpacing><b><span lang=EN-US>2.</span></b><b><span
style='font-family:宋体'>故障切换测试</span></b></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>故障切换是测试当某个节点出现故障后，</span><span
lang=EN-US>Keepalived</span><span style='font-family:宋体'>监制模块是否能及时发现然后屏蔽故障节点，同时将服务器转移到正常节点来执行。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>将</span><span lang=EN-US>192.168.254.130
</span><span style='font-family:宋体'>节点</span><span lang=EN-US>srs, squid</span><span
style='font-family:宋体'>服务停掉，假设这个节点出现故障，然后主、备机日志信息如下</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=132
id="图片 11" src="live_vod_cdn.files/image016.jpg"></span><span style='font-family:
宋体'>从以上可以看出，</span><span lang=EN-US>Keepalived</span><span style='font-family:
宋体'>监控模块检测到</span><span lang=EN-US>192.168.254.130</span><span
style='font-family:宋体'>这台主机出现故障后，将些</span><span lang=EN-US>130</span><span
style='font-family:宋体'>从集群系统中剔除掉了。</span><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNoSpacing style='text-indent:10.5pt'><span style='font-family:宋体'>重新启动</span><span
lang=EN-US>130</span><span style='font-family:宋体'>节点的</span><span lang=EN-US>srs,
squid</span><span style='font-family:宋体'>服务后查看</span></p>

<p class=MsoNoSpacing style='text-indent:10.5pt'><span lang=EN-US><img
border=0 width=554 height=193 id="图片 13" src="live_vod_cdn.files/image017.jpg"></span></p>

<p class=MsoNoSpacing><span lang=EN-US>Keepalived</span><span style='font-family:
宋体'>监控模块检测到</span><span lang=EN-US>130</span><span style='font-family:宋体'>这台主机恢复正常后，又将此节点加入集群系统中。</span></p>

<p class=MsoNoSpacing><b><span lang=EN-US style='font-family:宋体'>3.</span></b><b><span
style='font-family:宋体'>客户端直播与点播测试</span></b></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<h1><a name="_Toc33272384"></a><a name="_Toc436141407"></a><a
name="_Toc435713718"><span lang=EN-US>3.</span></a><span style='font-family:
宋体'>全局负载均衡及实现</span></h1>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>全局负载均衡（</span><span
lang=EN-US>GLSB</span><span style='font-family:宋体'>）就是负载解决多个节点之间相互协同的问题，实现整个系统的大规模服务能力和高可用性，基于</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>解析的</span><span lang=EN-US>GLSB,</span><span
style='font-family:宋体'>利用了</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>系统固有的域名解析，就近性判断，轮询算法等，可以在很大程度上借助独立于</span><span
lang=EN-US>CDN</span><span style='font-family:宋体'>系统之外的公共</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>系统来完成负载均衡</span><span
lang=EN-US>,</span><span style='font-family:宋体'>降低了对</span><span lang=EN-US>CDN</span><span
style='font-family:宋体'>本身的压力。为了更好的理解基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>解析的</span><span lang=EN-US>GLSB, </span><span
style='font-family:宋体'>首先对</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>系统一些基本概念做下简单介绍，对以后章节中实现</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>技术有更加深刻的了解。</span></p>

<h2><a name="_Toc33272385"></a><a name="_Toc436141408"></a><a
name="_Toc435713719"><span lang=EN-US>3.1 DSN</span></a><span style='font-family:
宋体'>简介</span></h2>

<h3><a name="_Toc33272386"></a><a name="_Toc436141409"></a><a
name="_Toc435713720"><span lang=EN-US>3.1.1</span></a><span style='font-family:
宋体'>根域与顶级域名服务器</span></h3>

<p class=MsoNormal><span lang=EN-US><img border=0 width=554 height=382 id="图片 2"
src="live_vod_cdn.files/image018.png"></span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>整个互联网中的域名空间结构就像一棵倒置的树，这棵域名树的根称为根域名服务器，在</span><span
lang=EN-US>internet</span><span style='font-family:宋体'>上共有</span><span
lang=EN-US>13</span><span style='font-family:宋体'>个<b>根</b></span><b><span
lang=EN-US>DNS</span></b><b><span style='font-family:宋体'>服务器</span></b><span
lang=EN-US>(</span><span style='font-family:宋体'>每个服务器其实都是一个集群组成</span><span
lang=EN-US> )</span><span style='font-family:宋体'>，大部分在北美。</span></p>

<p class=MsoNormal><span style='font-family:宋体'>往下的第一级节点称为<b>顶级域</b>，目前共有</span><span
lang=EN-US>7</span><span style='font-family:宋体'>个这样的顶级域（</span><span
lang=EN-US>COM,EDU,GOV,MIL,NET,ORG,INT</span><span style='font-family:宋体'>）</span><span
lang=EN-US>,</span><span style='font-family:宋体'>每个顶级域由对应的顶级域服务器负责管理。除了以上</span><span
lang=EN-US>7</span><span style='font-family:宋体'>个顶级域名，还有各个国家的顶级域名</span><span
lang=EN-US>(</span><span style='font-family:宋体'>如</span><span lang=EN-US>cn,
fr,ca</span><span style='font-family:宋体'>等</span><span lang=EN-US>)</span><span
style='font-family:宋体'>也是这一级别进行管理。每个顶级域可以向下展开分支，每个分支域是一个子域。比如</span><span
lang=EN-US>test.com</span><span style='font-family:宋体'>是域</span><span
lang=EN-US>com</span><span style='font-family:宋体'>的子域。</span><span lang=EN-US>Test.com</span><span
style='font-family:宋体'>也可再向下展开</span><span lang=EN-US>a.test.com, b.test.com. </span><span
style='font-family:宋体'>在每个域中，会有一台或多台服务器用来保存这个域名空间的所有信息，并且响应关于该域名空间的所有请求。这种助服务器就叫做这个域的权威域名服务器</span><span
lang=EN-US>(</span><span style='font-family:宋体'>也常称为授权域名服务器</span><span
lang=EN-US>)</span><span style='font-family:宋体'>，它拥有这个域所有的域名信息。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>根</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器，顶级域名服务器和权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器共同组成了</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器层，共同维护分布式，层次化的</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>数据库。对域进行授权，就是域管理组织把子域授权给其他组织进行管理，由子域管理者来维护子域中的数据，可以自由改动数据，包括对子域再进行划分，再授权。</span></p>

<h3><a name="_Toc33272387"></a><a name="_Toc436141410"></a><a
name="_Toc435713721"><span lang=EN-US>3.1.2</span></a><span style='font-family:
宋体'>本地</span><span lang=EN-US>DNS</span><span style='font-family:宋体'>服务器</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>在</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>系统中还有一类非常重要的域名服务器，叫做本地</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器，是用户所在局域网或</span><span
lang=EN-US>ISP</span><span style='font-family:宋体'>网络中的的域名服务器。我们平时上网在网络配置中设置的域名或使用</span><span
lang=EN-US>DHCP</span><span style='font-family:宋体'>获取的域名就是本地</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器地址。本地</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器得到浏览器的域名解析请求后，会用递归查询方式或者迭代查询方式向</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>系统中的其他远程域名服务器提出查询请求。递归方式指每次查询请求都向本地</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器发起，收到答复后现向下一个远程</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器提出请求，直到获得结果。迭代查询指本地</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器只将自己知道的最合适的答案返回给查询者，帮助它把查询过程继续下去，而它本身不现做其他任何查询。在实际应用中，递归方式是比较常见的。</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=554 height=281 id="图片 7"
src="live_vod_cdn.files/image019.png"></span></p>

<h3><a name="_Toc33272388"></a><a name="_Toc436141411"></a><a
name="_Toc435713722"><span lang=EN-US>3.1.3</span></a><span style='font-family:
宋体'>域名资源记录类型</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; </span><span style='font-family:
宋体'>域名服务器是根据资源记来对</span><span lang=EN-US>DNS</span><span style='font-family:
宋体'>请求进行应答的，在</span><span lang=EN-US>&nbsp;DNS</span><span style='font-family:
宋体'>系统中，最常见的资源记录是</span><span lang=EN-US> internet</span><span
style='font-family:宋体'>类记录，它主要分为以下几种类型：</span></p>

<p class=MsoListParagraph style='margin-left:46.5pt;text-indent:-36.0pt'><span
lang=EN-US>（1）<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>A</span><span style='font-family:宋体'>记录，</span><span
lang=EN-US> Address</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; A</span><span
style='font-family:宋体'>记录用于描述域名到</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>址的映射关系。对同个域名，可以有多条</span><span lang=EN-US>A</span><span
style='font-family:宋体'>记录。也就是说，一次</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>查找可以返回多个地址。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; (2) NS</span><span
style='font-family:宋体'>记录，</span><span lang=EN-US>Name Server</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; NS</span><span
style='font-family:宋体'>记录是域名服务记录，用于指定该域名由哪个</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器进行解析。每个区域可以有多个域名服务器，因此可以有多条</span><span lang=EN-US>NS</span><span
style='font-family:宋体'>记录。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; (3)SOA</span><span
style='font-family:宋体'>记录</span><span lang=EN-US>, Start Of Authority</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; SOA</span><span
style='font-family:宋体'>记录用于指定该区域的权威域名服务器。每个区域允许且只允许有一个</span><span lang=EN-US>SOA</span><span
style='font-family:宋体'>记录，它是资源记录的第一个条目。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; (4) CNAME </span><span
style='font-family:宋体'>记录</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; CNAME</span><span
style='font-family:宋体'>记录用于描述别名与域名的对应关系，这种记录允许您将多个名字映射到同台计算机。当域名服务器查找一个域名时，找到一条</span><span
lang=EN-US>CNAME</span><span style='font-family:宋体'>记录，它会用记录中的规范名来替换这个域名别名，然后再查这个规范名的</span><span
lang=EN-US>A</span><span style='font-family:宋体'>记录，从而找到与规范名对应的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址，这样，就实现了对请求查找域名的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址响应。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; (5)PTR</span><span
style='font-family:宋体'>记录，</span><span lang=EN-US>Pointor Record</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; PTR</span><span
style='font-family:宋体'>记录用于描述</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址到域名的映射关系。这种描述方式只存在于</span><span lang=EN-US>in-addr.arpa</span><span
style='font-family:宋体'>这个特殊的域中。</span></p>

<h2><a name="_Toc33272389"></a><a name="_Toc436141412"></a><a
name="_Toc435713723"><span lang=EN-US style='line-height:173%'>3.2 </span></a><span
style='line-height:173%;font-family:宋体'>基于</span><span lang=EN-US
style='line-height:173%'>DNS</span><span style='line-height:173%;font-family:
宋体'>解析</span><span style='font-family:宋体'>实现</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>方法</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; </span><span style='font-family:
宋体'>基于</span><span lang=EN-US>DNS</span><span style='font-family:宋体'>解析的</span><span
lang=EN-US>GSLB</span><span style='font-family:宋体'>方案实际上就是把负载均衡设备部署在</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>系统中。在用户发出任何应用连接请求时，首先必须通过</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>系统来请求获得服务器的</span><span
lang=EN-US>IP</span><span style='font-family:宋体'>地址，基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>的</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>正是在返回</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>解析结果的过程中进行智能决策，给用户返回一个最佳的服务器的</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址。</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>是基于轮询机制来提供简单负载分配能力的。在具体应用中，基于</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>解析来实现</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>有几种方法。</span></p>

<h4><span lang=EN-US>3.2.1 </span><span style='font-family:宋体'>通过</span><span
lang=EN-US>CNAME</span><span style='font-family:宋体'>方式实现负载均衡</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>通过</span><span
lang=EN-US>CNAME</span><span style='font-family:宋体'>方式来实现负载均衡，实际上是利用了</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>的两个机制：一是别名机制，二是轮询机制。具体操作简单地说就是</span><span
lang=EN-US>:</span><span style='font-family:宋体'>先将</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>的主机名定义为所查询域名的权威</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器的别名，然后将</span><span lang=EN-US>GSLB</span><span
style='font-family:宋体'>主机名添加多条</span><span lang=EN-US>A</span><span
style='font-family:宋体'>记录，分别对应多个服务器的</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址。这样本地</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器会向客户端返回多个</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址作为域名的查询结果。并且这些</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址的排列顺序是轮换的。客户端一般会选择首个</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地址进行访问。</span></p>

<h4><span lang=EN-US>3.2.2 </span><span style='font-family:宋体'>负载均衡器作为权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>这种方式是把负载均衡器作为一个域名空间的权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器，这样负载均衡器就会接收所有对这个域的</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>请求，从而能够根据预先设置的一些策略来提供对域名的智能</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>解析。</span></p>

<h4><span lang=EN-US>3.2.3 </span><span style='font-family:宋体'>负载均衡器作为代理</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>在这种方式下，负载均衡器被注册为一个域名空间的权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器，而真正的权威域名服务器则部署在负载均衡器后面。所有的</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>请求都会先到达负载均衡器，由负载均衡器转发至真正的权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器，然后修改权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器返回的响应信息，从而实现负载均衡功能。为实现这一过程，首先要将对外公布的权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器的地址注册成负载均衡器上的</span><span
lang=EN-US>VIP</span><span style='font-family:宋体'>地址。直正的权威</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器正常响应浏览器的</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>请求，返回域名解析结果列表，这个响应会先发送到负载均衡器，</span></p>

<h2><a name="_Toc33272390"></a><a name="_Toc436141413"></a><a
name="_Toc435713724"><span lang=EN-US>3.3 BIND</span></a><span
style='font-family:宋体'>开源域名服务器</span></h2>

<p class=MsoNormal style='text-indent:15.75pt'><span lang=EN-US>Bind</span><span
style='font-family:宋体'>是一款开放源码的</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器软件，</span><span lang=EN-US>Bind</span><span
style='font-family:宋体'>由美国加州大学</span><span lang=EN-US>Berkeley</span><span
style='font-family:宋体'>分校开发和维护的，全名为</span><span lang=EN-US>Berkeley Internet
Name Domain</span><span style='font-family:宋体'>它是目前世界上使用最为广泛的</span><span
lang=EN-US>DNS</span><span style='font-family:宋体'>服务器软件，支持各种</span><span
lang=EN-US>unix</span><span style='font-family:宋体'>平台和</span><span lang=EN-US>windows</span><span
style='font-family:宋体'>平台。</span></p>

<p class=MsoNormal style='text-indent:15.75pt'><span style='font-family:宋体'>官网</span><span
lang=EN-US>: <a href="http://www.isc.org/downloads/">http://www.isc.org/downloads/</a></span></p>

<h2><a name="_Toc33272391"></a><a name="_Toc436141414"></a><a
name="_Toc435713725"><span lang=EN-US>3.4 </span></a><span style='font-family:
宋体'>全局负载均衡实现</span></h2>

<h3><a name="_Toc33272392"></a><a name="_Toc436141415"></a><a
name="_Toc435713726"><span lang=EN-US>3.4.1 </span></a><span style='font-family:
宋体'>系统环境</span></h3>

<p class=MsoNoSpacing><span style='font-family:宋体'>系统平台：</span><span
lang=EN-US>VMware&nbsp; centos 7</span></p>

<p class=MsoNoSpacing><span lang=EN-US>DNS</span><span style='font-family:宋体'>版本：</span><span
lang=EN-US>BIND 9.9.4-RedHat-9.9.4-18</span></p>

<p class=MsoNormal><span style='font-family:宋体'>全局负载均衡域名服务器：</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-family:宋体'>网卡</span><span lang=EN-US>1:192.168.254.137</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-family:宋体'>网卡</span><span lang=EN-US>2:192.168.230.136</span></p>

<p class=MsoNormal><span style='font-family:宋体'>电信授权域名服务器</span><span
lang=EN-US>::192.168.254.133</span></p>

<p class=MsoNormal><span style='font-family:宋体'>电信客户端</span><span lang=EN-US>::192.168.254.132</span></p>

<p class=MsoNormal><span style='font-family:宋体'>联通授权域名服务器</span><span
lang=EN-US>::192.168.230..130</span></p>

<p class=MsoNormal><span style='font-family:宋体'>联通客户端</span><span lang=EN-US>:192.168.230.134</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>GSLB</span><span style='font-family:宋体'>部署架构图</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=681 height=523
src="live_vod_cdn.files/image020.png"></span></p>

<h3><a name="_Toc33272393"></a><a name="_Toc436141416"></a><a
name="_Toc435713727"><span lang=EN-US>3.4.2 </span></a><span style='font-family:
宋体'>安装与编译</span></h3>

<p class=MsoNormal><span lang=EN-US>1.</span><span style='font-family:宋体'>官方下载</span></p>

<p class=MsoNormal><span lang=EN-US><a href="http://www.isc.org/software/bind">http://www.isc.org/software/bind</a></span></p>

<p class=MsoNormal><span lang=EN-US>2.</span><span style='font-family:宋体'>编译安装</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>可以下载源代码安装，也可以系统自动安装，测试环境是使用如下命令系统自动安装</span></p>

<p class=MsoNoSpacing><span lang=EN-US>yum install bind</span></p>

<h3><a name="_Toc33272394"></a><a name="_Toc436141417"></a><a
name="_Toc435713728"><span lang=EN-US>3.4.3</span></a><span style='font-family:
宋体'>配置</span></h3>

<p class=MsoNormal><span style='font-family:宋体'>使用方法在各服务器安装成功后，根据下面的步骤，来配置授权域名服务器与</span><span
lang=EN-US>GSLB</span><span style='font-family:宋体'>服务器</span></p>

<h4><span lang=EN-US>3.4.3.1 </span><span style='font-family:宋体'>授权域名服务器配置</span></h4>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) </span><span style='font-family:宋体'>电信授权域名服务器配置</span></h5>

<p class=MsoNormal style='text-indent:5.25pt'><span style='font-family:宋体'>电信使用</span><span
lang=EN-US>254</span><span style='font-family:宋体'>网段模拟，授权服务器为</span><span
lang=EN-US>192.168.254.133</span></p>

<p class=MsoNormal><span lang=EN-US>1&gt;</span><span style='font-family:宋体'>配置</span><span
lang=EN-US>/etc/named.conf</span><span style='font-family:宋体'>加如下内容</span></p>

<p class=MsoNormal><span lang=EN-US>options {&nbsp; //</span><span
style='font-family:宋体'>全局配置</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; directory
&quot;/var/named&quot;;&nbsp;&nbsp;&nbsp; //</span><span style='font-family:
宋体'>区域数据文件等存放路径</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; recursion yes;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//</span><span style='font-family:宋体'>使用递归查询</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>zone &quot;testcdn.com&quot; {&nbsp; ;</span><span
style='font-family:宋体'>解析</span><span lang=EN-US>testcdn.com&nbsp;&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; type master;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span style='font-family:宋体'>该域为主域名服务器</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; file
&quot;testcdn.com.zone&quot;;&nbsp;&nbsp; ;</span><span style='font-family:
宋体'>区域数据文件名称</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>2&gt;</span><span style='font-family:宋体'>建立区域数据文件内容后下</span><span
lang=EN-US>/var/named/testcnd.com.zone</span></p>

<p class=MsoNormal><span lang=EN-US>$TTL 3600&nbsp; </span><span lang=EN-US>;</span><span
style='font-family:宋体'>定义了其他</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器缓存本机数据的默认时间，默认单位是秒</span></p>

<p class=MsoNormal><span lang=EN-US>@ &nbsp;IN &nbsp;SOA &nbsp;testcdn.com. &nbsp;admin@testcdn.com.
&nbsp;(</span></p>

<p class=MsoNormal style='margin-left:89.25pt;text-indent:-89.25pt'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span lang=EN-US>SOA</span><span style='font-family:宋体'>是</span><span
lang=EN-US>Start of Authority</span><span style='font-family:宋体'>（起始授权机构）的缩写，它指出这个域名服务器是作为该区数据的权威的来源。在指令</span><span
lang=EN-US>@ &nbsp;IN &nbsp;SOA &nbsp;testcdn.com. &nbsp;admin@testcdn.com.</span><span
lang=EN-US>&quot;</span><span style='font-family:宋体'>中，指定了负责解析本域的授权主机名是</span><span
lang=EN-US>&quot;</span><span lang=EN-US> testcdn.com</span><span lang=EN-US>.&quot;</span><span
style='font-family:宋体'>，授权主机名称将在区域文件中解析为</span><span lang=EN-US>IP</span><span
style='font-family:宋体'>地</span> <span style='font-family:宋体'>址。</span><span
lang=EN-US>IN</span><span style='font-family:宋体'>表示属于</span><span lang=EN-US>Internet</span><span
style='font-family:宋体'>类，是固定不变的，</span><span lang=EN-US>admin@testcdn.com</span><span
lang=EN-US>.&quot;</span><span style='font-family:宋体'>表示负责该区域的管理员的</span><span
lang=EN-US>E-mail</span><span style='font-family:宋体'>地址。每一个区文件都需要一个</span><span
lang=EN-US> SOA</span><span style='font-family:宋体'>记录，而且只能有一个。</span><span
lang=EN-US>SOA</span><span style='font-family:宋体'>资源记录还要指定一些附加参数，放在</span><span
lang=EN-US>SOA</span><span style='font-family:宋体'>资源记录后面的括号内，其名称和功能见例子中的注释。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<pre><span lang=EN-US style='font-size:10.5pt'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;20151011 ;</span><span
style='font-size:10.5pt'>定义序列号的值，同步辅助名称服务器数据时使用</span></pre><pre
style='margin-left:131.25pt;text-indent:-131.25pt'><span lang=EN-US
style='font-size:10.5pt'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28800 ; </span><span
style='font-size:10.5pt'>更新时间间隔值。定义该服务器的辅助名称服务器隔多久时间更新一次 </span></pre><pre><span
lang=EN-US style='font-size:10.5pt'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7200&nbsp; ;</span><span
style='font-size:10.5pt'>辅助名称服务器更新失败时，重试的间隔时间</span></pre><pre><span
lang=EN-US style='font-size:10.5pt'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3600000&nbsp; ;</span><span
style='font-size:10.5pt'>辅助名称服务器一直不能更新时，其数据过期的时间</span></pre><pre><span
lang=EN-US style='font-size:10.5pt'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6400&nbsp;&nbsp; ;</span><span
style='font-size:10.5pt'>最小默认<span lang=EN-US>TTL</span>的值，如果第一行没有<span
lang=EN-US>$TTL</span>，则使用该值 </span></pre>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
)</span></p>

<p class=MsoNormal style='margin-left:210.0pt;text-indent:-210.0pt'><span
lang=EN-US>testcdn.com.&nbsp;&nbsp;&nbsp; IN NS ns.testcdn.com.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; </span><span style='font-family:宋体'>是一条</span><span lang=EN-US>NS</span><span
style='font-family:宋体'>（</span><span lang=EN-US>Name Server</span><span
style='font-family:宋体'>）资源记录，定义了域</span><span lang=EN-US>&quot;testcdn.com.&quot;</span><span
style='font-family:宋体'>由</span><span lang=EN-US>DNS</span><span
style='font-family:宋体'>服务器</span><span lang=EN-US>&quot; ns.testcdn.com.&quot;</span><span
style='font-family:宋体'>负责解析，</span><span lang=EN-US>NS</span><span
style='font-family:宋体'>资源记录定义的服务器称为区域权威名称服务器。权威名称服务器负责维护和管理所管辖区域中的数据，被其他服务器或客户端当作权威的来源，并且能肯定应答区域内所含名称的查询。这里的配置要求和</span><span
lang=EN-US> SOA</span><span style='font-family:宋体'>记录配置一致。</span></p>

<p class=MsoNormal style='margin-left:220.5pt;text-indent:-220.5pt'><span
lang=EN-US>www &nbsp;&nbsp;IN &nbsp;CNAME &nbsp;testcdn.live.com.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span style='font-family:宋体'>定义</span><span lang=EN-US><a
href="http://www.testcdn.com">www.testcdn.com</a> </span><span
style='font-family:宋体'>的别名为</span><span lang=EN-US>gslb</span><span
style='font-family:宋体'>主机</span><span lang=EN-US>;</span><span
style='font-family:宋体'>名</span><span lang=EN-US>testcdn.live.com</span></p>

<p class=MsoNormal><span lang=EN-US>ns.testcdn.com. &nbsp;IN &nbsp;A &nbsp;192.168.254.133&nbsp;&nbsp;
;</span><span style='font-family:宋体'>定义</span><span lang=EN-US>ns.testcdn.com.</span><span
style='font-family:宋体'>的记录为</span><span lang=EN-US>192.168.254.133</span></p>

<p class=MsoNormal><span lang=EN-US>live IN NS ns.live.testcdn.com.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span style='font-family:宋体'>定义子域</span><span lang=EN-US>live</span><span
style='font-family:宋体'>由</span><span lang=EN-US>ns.live.testcdn.com</span><span
style='font-family:宋体'>解析</span></p>

<p class=MsoNormal style='margin-left:210.0pt;text-indent:-210.0pt'><span
lang=EN-US>ns.live.testcdn.com.&nbsp;&nbsp; IN A 192.168.254.137&nbsp;
;ns.live.testcdn.com</span><span style='font-family:宋体'>的地址，实例中就是</span><span
lang=EN-US>GSLB</span><span style='font-family:宋体'>的地址</span></p>

<p class=MsoNormal style='margin-left:210.0pt;text-indent:-210.0pt'><span
lang=EN-US>www IN CNAME live.testcdn.com.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span style='font-family:宋体'>定义</span><span lang=EN-US>www</span><span
style='font-family:宋体'>的别名为</span><span lang=EN-US>live.testcdn.com</span><span
style='font-family:宋体'>，注意</span><span lang=EN-US>:</span><span
style='font-family:宋体'>有时定义后面有符号</span><span lang=EN-US>.&nbsp; </span><span
style='font-family:宋体'>没有代表需要加上本域，例如</span><span lang=EN-US>:</span></p>

<p class=MsoNormal style='margin-left:210.0pt;text-indent:-210.0pt'><span
lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
www</span><span style='font-family:宋体'>代表域</span><span lang=EN-US>:www.testcdn.com</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>电信客户端配置</span></h5>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>在电信客户端需要配置指向电信域名服务器，这该测试环境中是直接指向电信授权域名服务器，实际环境中一般都是连接的本地域名服务器。测试环境修改</span><span
lang=EN-US>/etc/resolv.conf</span><span style='font-family:宋体'>为下如下内容</span></p>

<p class=MsoNormal><span lang=EN-US>nameserver &nbsp;192.168.254.133</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>三</span><span
lang=EN-US>) </span><span style='font-family:宋体'>联通授权域名服务器配置</span></h5>

<p class=MsoNormal><span style='font-family:宋体'>联通使用</span><span lang=EN-US>230</span><span
style='font-family:宋体'>网段模拟，授权服务器为</span><span lang=EN-US>192.168.230.130</span></p>

<p class=MsoNormal><span lang=EN-US>1&gt;</span><span style='font-family:宋体'>配置</span><span
lang=EN-US>/etc/named.conf</span><span style='font-family:宋体'>加如下内容</span></p>

<p class=MsoNormal><span lang=EN-US>options {&nbsp; //</span><span
style='font-family:宋体'>全局配置</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; directory
&quot;/var/named&quot;;&nbsp;&nbsp;&nbsp; //</span><span style='font-family:
宋体'>区域数据文件等存放路径</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; recursion yes;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//</span><span style='font-family:宋体'>使用递归查询</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>zone &quot;testcdn.com&quot; {&nbsp; ;</span><span
style='font-family:宋体'>解析</span><span lang=EN-US>testcdn.com&nbsp;&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; type master;&nbsp;&nbsp;&nbsp;&nbsp;
;</span><span style='font-family:宋体'>该域为主域名服务器</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; file
&quot;testcdn.com.zone&quot;;&nbsp;&nbsp; ;</span><span style='font-family:
宋体'>区域数据文件名称</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>2&gt;</span><span style='font-family:宋体'>建立区域数据文件内容后下</span><span
lang=EN-US>/var/named/testcnd.com.zone</span></p>

<p class=MsoNormal><span lang=EN-US>$TTL 3600</span></p>

<p class=MsoNormal><span lang=EN-US>@ IN SOA testcdn.com.&nbsp;
admin.testcdn.com. (</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
20151011</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
28800</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
7200</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3600000</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
6400</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
)</span></p>

<p class=MsoNormal><span lang=EN-US>testcdn.com.&nbsp;&nbsp;&nbsp; In NS
ns.testcdn.com.</span></p>

<p class=MsoNormal><span lang=EN-US>ns.testcdn.com. IN A 192.168.230.130</span></p>

<p class=MsoNormal><span lang=EN-US>live IN NS ns.live.testcdn.com.</span></p>

<p class=MsoNormal><span lang=EN-US>ns.live.testcdn.com.&nbsp;&nbsp; IN A
192.168.230.136</span></p>

<p class=MsoNormal><span lang=EN-US>www IN CNAME live.testcdn.com.</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>四</span><span
lang=EN-US>) </span><span style='font-family:宋体'>联通客户端配置</span></h5>

<p class=MsoNormal><span style='font-family:宋体'>客户端域名服务器配置</span><span
lang=EN-US>/etc/resolv.conf</span><span style='font-family:宋体'>为下如下内容</span></p>

<p class=MsoNormal><span lang=EN-US>nameserver &nbsp;192.168.254.130</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h4><span lang=EN-US>3.4.3.2 GLSB</span><span style='font-family:宋体'>域名服务器配置</span></h4>

<p class=MsoNormal><span lang=EN-US>1&gt;</span><span style='font-family:宋体'>配置</span><span
lang=EN-US>/etc/named.conf</span><span style='font-family:宋体'>加如下内容</span></p>

<p class=MsoNormal><span lang=EN-US>options {</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; directory
&quot;/var/named&quot;;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; recursion yes;</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:78.75pt;text-indent:-78.75pt'><span
lang=EN-US>view &quot;dx&quot; {&nbsp;&nbsp;&nbsp; </span><span lang=EN-US>&nbsp;//</span><span
style='font-family:宋体'>由于主机解析查询时会轮询使用解析到的服务器，而</span><span lang=EN-US>view</span><span
style='font-family:宋体'>则根据客户端的来源不同，将同一个名称解析至不同的值，不做轮询。</span> <span
style='font-family:宋体'>&nbsp;鉴于我国的各地既有联通网络，又有电信网络，而联通电信之间的连接靠的是北京机房的中转，那么可以想象，如果你处在电信网络下，向联通服务器发起请求的速
度会有多慢。为了解决这种状况，边出现了<span lang=EN-US>bind view </span>这种功能，让联通用户至访问联通服务器，电信只访问电信。这样速度就会快很多了。</span><span
style='font-size:12.0pt;font-family:宋体'> </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:178.5pt;text-indent:-178.5pt'><span
lang=EN-US>&nbsp;&nbsp; match-clients { 192.168.254.0/24; };&nbsp; //</span><span
style='font-family:宋体'>定义局域网</span><span lang=EN-US>192.168.254.1-255 </span><span
style='font-family:宋体'>会电信网络，这是测试环境，虚拟使用，直实环境可以使且</span><span lang=EN-US>acl</span><span
style='font-family:宋体'>访问控制列表，</span><span lang=EN-US>acl</span><span
style='font-family:宋体'>列表中为电信的</span><span lang=EN-US>ip</span><span
style='font-family:宋体'>地址</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; zone &quot;live.testcdn.com&quot;
{</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
type master;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
file &quot;testcdn.com.zone.dx&quot;;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; };</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>view &quot;lt&quot; { //</span><span
style='font-family:宋体'>定义联通区域授权</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; match-clients
{192.168.230.0/24; };</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone &quot;live.testcdn.com&quot;
{</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
type master;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;file
&quot;testcdn.com.zone.lt&quot;;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span></p>

<p class=MsoNormal><span lang=EN-US>};</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>2&gt;</span><span style='font-family:宋体'>建立电信区域数据文件</span><span
lang=EN-US>/var/named/testcdn.com.zone.dx</span><span style='font-family:宋体'>，</span></p>

<p class=MsoNormal><span lang=EN-US>$TTL 3600</span></p>

<p class=MsoNormal><span lang=EN-US>@ IN SOA ns.live.testcdn.com.
admin.testcdn.com. (</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
20151011</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
28800</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
7200</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3600000</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
6400</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
)</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; IN NS ns</span></p>

<p class=MsoNormal><span lang=EN-US>ns IN A 192.168.254.137</span></p>

<p class=MsoNormal><span lang=EN-US>@&nbsp; IN A 192.168.254.120</span></p>

<p class=MsoNormal><span lang=EN-US>@&nbsp; IN A 192.168.254.220</span></p>

<p class=MsoNormal><span lang=EN-US>3&gt;</span><span style='font-family:宋体'>建立联通区域数据文件</span><span
lang=EN-US>/var/named/testcdn.com.zone.lt</span></p>

<p class=MsoNoSpacing><span lang=EN-US>$TTL 3600</span></p>

<p class=MsoNoSpacing><span lang=EN-US>@&nbsp; IN SOA ns.live.testcdn.com. admin.testcdn.com.
(</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
20151011</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
28800</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
7200</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
3600000</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
6400</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
)</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;&nbsp;&nbsp; IN&nbsp; NS&nbsp; ns</span></p>

<p class=MsoNoSpacing><span lang=EN-US>ns&nbsp; IN&nbsp; A&nbsp;
192.168.230.137</span></p>

<p class=MsoNoSpacing><span lang=EN-US>@&nbsp;&nbsp; IN&nbsp; A&nbsp;
192.168.230.135</span></p>

<p class=MsoNoSpacing><span lang=EN-US>@&nbsp;&nbsp; IN&nbsp; A&nbsp;
192.168.230.134</span></p>

<h3><a name="_Toc33272395"></a><a name="_Toc436141418"></a><a
name="_Toc435713729"><span lang=EN-US>3.4.4 </span></a><span style='font-family:
宋体'>测试</span></h3>

<h4><span lang=EN-US>3.4.4.1 </span><span style='font-family:宋体'>启动域名服务</span></h4>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>使用如下命令，启动域名服务器，不同版本</span><span
lang=EN-US>linux</span><span style='font-family:宋体'>操作系统启动可能不同，测试环境是在</span><span
lang=EN-US>centos 7</span><span style='font-family:宋体'>下，使用下面的命令启动</span><span
lang=EN-US>glsb,</span><span style='font-family:宋体'>电信，联通授权域名服务器域名服务。</span></p>

<p class=MsoNormal><span lang=EN-US>systemctl&nbsp; start &nbsp;named.service</span></p>

<p class=MsoNormal><span style='font-family:宋体'>在客户端配置域名指向授权域名服务器，因为测试环境省略了本地域名服务器，直接连接到授权域名服务器</span></p>

<h4><span lang=EN-US>3.4.4.2 </span><span style='font-family:宋体'>命令测试</span></h4>

<p class=MsoNoSpacing style='text-indent:21.0pt'><span style='font-family:宋体'>测试过程可以使用</span><span
lang=EN-US>nslookup </span><span style='font-family:宋体'>与</span><span
lang=EN-US> dig</span><span style='font-family:宋体'>测试。下面实例使用</span><span
lang=EN-US>dig</span><span style='font-family:宋体'>命令。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>测试电信环境</span><span
lang=EN-US>:</span><span style='font-family:宋体'>客户端</span><span lang=EN-US>192.168.254.132</span><span
style='font-family:宋体'>下输入</span><span lang=EN-US>dig&nbsp; www.testcdn.com</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=384
id="图片 8" src="live_vod_cdn.files/image021.png"></span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>如果输出以上结果，表示，环境已经搭建成功，</span><span
lang=EN-US>www.testcdn.com </span><span style='font-family:宋体'>这个域名会解析两个</span><span
lang=EN-US>A</span><span style='font-family:宋体'>记录，对应两个</span><span lang=EN-US>ip</span><span
style='font-family:宋体'>地址。</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>测试联通环境</span><span
lang=EN-US>: </span><span style='font-family:宋体'>客户端</span><span lang=EN-US>192.168.230.134</span><span
style='font-family:宋体'>下输入</span><span lang=EN-US>dig&nbsp; <a
href="http://www.testcdn.com">www.testcdn.com</a></span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=357
id="图片 9" src="live_vod_cdn.files/image022.jpg"></span></p>

<h1><a name="_Toc33272396"></a><a name="_Toc436141419"><span lang=EN-US>4.</span></a><span
style='font-family:宋体'>网络存储及实现</span></h1>

<h2><a name="_Toc33272397"></a><a name="_Toc436141420"><span lang=EN-US>4.1</span></a><span
style='font-family:宋体'>网络存储技术</span></h2>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>目前高端服务器使用的专业网络存储技术大概分为四种，有</span><span
lang=EN-US>DAS</span><span style='font-family:宋体'>、</span><span lang=EN-US>NAS</span><span
style='font-family:宋体'>、</span><span lang=EN-US>SAN </span><span
style='font-family:宋体'>、</span><span lang=EN-US>ISCSL</span><span
style='font-family:宋体'>，它们可以使用</span><span lang=EN-US>RAID</span><span
style='font-family:宋体'>阵列提供高效的安全存储空间。</span></p>

<h3><a name="_Toc33272398"></a><a name="_Toc436141421"><span lang=EN-US>4.1.1</span></a><span
style='font-family:宋体'>直接附加存储</span><span lang=EN-US>(DAS)</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span><span
style='font-family:宋体'>直接附加存储是指将存储设备通过</span><span lang=EN-US>SCSI</span><span
style='font-family:宋体'>接口直接连接到一台服务器上使用。</span><span lang=EN-US>DAS</span><span
style='font-family:宋体'>购置成本低，配置简单，使用过程和使用本机硬盘并无太大差别，对于服务器的要求仅仅是一个外接的</span><span
lang=EN-US>SCSI</span><span style='font-family:宋体'>口，</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span><span
style='font-family:宋体'>因此对于小型企业很有吸引力。但是</span><span lang=EN-US>DAS</span><span
style='font-family:宋体'>也存在诸多问题：</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(1)</span><span
style='font-family:宋体'>服务器本身容易成为系统瓶颈</span><span lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(2)</span><span
style='font-family:宋体'>服务器发生故障，数据不可访问</span><span lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(3)</span><span
style='font-family:宋体'>对于存在多个服务器的系统来说，设备分散，不便管理。同时多台服务器使用</span><span
lang=EN-US>DAS</span><span style='font-family:宋体'>时，存储空间不能在服务器之间动态分配，可能造成相当的资源浪费</span><span
lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(4)</span><span
style='font-family:宋体'>数据备份操作复杂。</span></p>

<h3><a name="_Toc33272399"></a><a name="_Toc436141422"><span lang=EN-US>4.1.2</span></a><span
style='font-family:宋体'>网络附加存储</span><span lang=EN-US>(NAS)</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;NAS</span><span
style='font-family:宋体'>实际是一种带有瘦服务器的存储设备。这个瘦服务器实际是一台网络文件服务器。</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>设备直接连接到</span><span
lang=EN-US>TCP/IP</span><span style='font-family:宋体'>网络上，网络服务器通过</span><span
lang=EN-US>TCP/IP</span><span style='font-family:宋体'>网络存取管理数据。</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>作为一种瘦服务器系统，易于安装和部署，管理使用也很方便。同时由于可以允许客户机不通过服务器直接在</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>中存取数据，因此对服务器来说可以减少系统开销。</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>为异构平台使用统一存储系统提供了解决方案。由于</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>只需要在一个基本的磁盘阵列柜外增加一套瘦服务器系统，对硬件要求很低，软件成本也不高，甚至可以使用免费的</span><span
lang=EN-US>LINUX&nbsp; </span><span style='font-family:宋体'>解决方案，成本只比直接附加存储略高。</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>存在的主要问题是：</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(1)</span><span
style='font-family:宋体'>由于存储数据通过普通数据网络传输，因此易受网络上其它流量的影响。当网络上有其它大数据</span><span
lang=EN-US>&nbsp; </span><span style='font-family:宋体'>流量时会严重影响系统性能</span><span
lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(2)</span><span
style='font-family:宋体'>由于存储数据通过普通数据网络传输，因此容易产生数据泄漏等安全问题</span><span lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(3)</span><span
style='font-family:宋体'>存储只能以文件方式访问，而不能像普通文件系统一样直接访问物理数据块，因此会在某些情况下严重影响系统效率，比如大型数据库</span><span
lang=EN-US>&nbsp; </span><span style='font-family:宋体'>就不能使用</span><span
lang=EN-US>NAS.</span></p>

<h3><a name="_Toc33272400"></a><a name="_Toc436141423"><span class=3><span
lang=EN-US>4.1.3</span></span></a><span class=3><span style='font-family:宋体'>存储区域网</span><span
lang=EN-US>(SAN</span></span><span lang=EN-US>)</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;SAN</span><span
style='font-family:宋体'>实际是一种专门为存储建立的独立于</span><span lang=EN-US>TCP/IP</span><span
style='font-family:宋体'>网络之外的专用网络。目前一般的</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>提供</span><span lang=EN-US>2Gb/S</span><span
style='font-family:宋体'>到</span><span lang=EN-US>4Gb/S</span><span
style='font-family:宋体'>的传输数率，同时</span><span lang=EN-US>SAN</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>网络独立于数据网络存在，因此存取速度很快，另外</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>一般采用高端的</span><span
lang=EN-US>RAID</span><span style='font-family:宋体'>阵列，使</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>的性能在几种专业网络存储技术中傲视群雄。</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>由于其基础是一个专用网络，因此扩展性很强，不管是在一个</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>系统中增加一定的存储空间还是增加几台使用存储空间的服务器都非常方便。通过</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>接口的磁带机，</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>系统可以方便高效的实现数据的集中备份。</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>作为一种新兴的存储方式，是未来存储技术的发展方向，但是，它也存在一些缺点：</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(1)</span><span
style='font-family:宋体'>价格昂贵。不论是</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>阵列柜还是</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>必须的光纤通道交换机价格都是十分昂贵的，就连服务器上使用的光通道卡的价格也是不容易被小型商业企业所接受的</span><span
lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(2)</span><span
style='font-family:宋体'>需要单独建立光纤网络，异地扩展比较困难</span><span lang=EN-US>;</span></p>

<h3><a name="_Toc33272401"></a><a name="_Toc436141424"><span lang=EN-US>4.1.4 iSCSI</span></a></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span><span
style='font-family:宋体'>使用专门的存储区域网成本很高，而利用普通的数据网来传输</span><span lang=EN-US>SCSI</span><span
style='font-family:宋体'>数据实现和</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>相似的功能可以大大的降低成本，同时提高系统的灵活性。</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>就是这样一种技术，它利用普通的</span><span lang=EN-US>TCP/IP</span><span
style='font-family:宋体'>网来传输本来用存储区域网来传输的</span><span lang=EN-US>SCSI</span><span
style='font-family:宋体'>数据块。</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>的成本相对</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>来说要低不少。随着千兆网的普及，万兆网也逐渐的进入主流，使</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>的速度相对</span><span lang=EN-US>SAN</span><span
style='font-family:宋体'>来说并没有太大的劣势。</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>目前存在的主要问题是：</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(1)</span><span
style='font-family:宋体'>新兴的技术，提供完整解决方案的厂商较少，对管理者技术要求高</span><span lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(2)</span><span
style='font-family:宋体'>通过普通网卡存取</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>数据时，解码成</span><span lang=EN-US>SCSI</span><span
style='font-family:宋体'>需要</span><span lang=EN-US>CPU</span><span
style='font-family:宋体'>进行运算，增加了系统性能开销，如果采用专门的</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>网卡虽然可以减少系统性能开销，但会大大增加成本</span><span lang=EN-US>;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>(3)</span><span
style='font-family:宋体'>使用数据网络进行存取，存取速度冗余受网络运行状况的影响。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>四种网络存储技术的主要区别</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span><span
style='font-family:宋体'>通过以上比较研究，四种网络存储技术方案各有优劣。对于小型且服务较为集中的商业企业，可采用简单的</span><span
lang=EN-US>DAS</span><span style='font-family:宋体'>方案。对于中小型商业企业，服务器数量比较少，有一定的数据集中管理要求，且没有大型数据库需求的可采用</span><span
lang=EN-US>NAS</span><span style='font-family:宋体'>方案。对于大中型商业企业，</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>和</span><span lang=EN-US>iSCSI</span><span
style='font-family:宋体'>是较好的选择。如果希望使用存储的服务器相对比较集中，且对系统性能要求极高，可考虑采用</span><span
lang=EN-US>SAN</span><span style='font-family:宋体'>方案</span><span lang=EN-US>;</span><span
style='font-family:宋体'>对于希望使用存储的服务器相对比较分散，又对性能要求不是很高的，可以考虑采用</span><span
lang=EN-US>iSCSI</span><span style='font-family:宋体'>方案。</span></p>

<h2><a name="_Toc33272402"></a><a name="_Toc436141425"><span lang=EN-US>4.2</span></a><span
style='font-family:宋体'>分布式存储</span></h2>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>在流媒体系统的缓冲设备与</span><span
lang=EN-US>web</span><span style='font-family:宋体'>缓冲设备对</span><span lang=EN-US>cpu</span><span
style='font-family:宋体'>性能和</span><span lang=EN-US>IO</span><span
style='font-family:宋体'>能力要求差别很大，</span><span lang=EN-US>web</span><span
style='font-family:宋体'>缓冲需要应对小文件，高并发要求，这样的业务特性对</span><span lang=EN-US>cpu</span><span
style='font-family:宋体'>消耗非常大，而流媒体</span><span lang=EN-US>cdn</span><span
style='font-family:宋体'>的缓冲则需要应对大文件持续读写，</span><span lang=EN-US>tcp</span><span
style='font-family:宋体'>长连接维持要求，这对磁盘</span><span lang=EN-US>IO</span><span
style='font-family:宋体'>能力要求非常高。另外一个主要差别是，</span><span lang=EN-US>web</span><span
style='font-family:宋体'>缓冲一般不需要配置很大的存储空间，而流媒体缓冲则需要外挂</span><span lang=EN-US>TB</span><span
style='font-family:宋体'>级别的磁盘，因为流媒体文件实在是太占用存储空间了。为了保证连续媒体数据的实时磁盘访问，需要将数据以合适的块大小分布在磁盘的各个区域，并以最佳的顺序从磁盘中读取。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span style='font-family:宋体'>分布式存储技术因其大容量、低成本的特点，目前也被业界关注的研究作为流媒体</span><span
lang=EN-US>CDN</span><span style='font-family:宋体'>系统的存储解决方案之一。常用的分布式存储技术包括分布式文件系统和分布式数据库，由于采用了数据副本冗余（每份数据复制</span><span
lang=EN-US>2-3</span><span style='font-family:宋体'>份）、磁盘冗余</span><span
lang=EN-US>(Raid1,Raid10,Raid5)</span><span style='font-family:宋体'>等技术，通常可以提供良好的数据容错机制，当单台存储设备断电或者单个存储磁盘失效时，整个存储系统仍能正常工作。分布式文件系统更常见于高性能计算领域</span></p>

<h3><a name="_Toc33272403"></a><a name="_Toc436141426"><span lang=EN-US>4.2.1</span></a><span
style='font-family:宋体'>分布式存储实现实例</span><span lang=EN-US>MooseFS</span></h3>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;MooseFS</span><span
style='font-family:宋体'>是一个具有容错性的网络分布式文件系统。它把数据分散存放在多个物理服务器上，而呈现给用户的则是一个统一的资源。</span><span
lang=EN-US>Mfs</span><span style='font-family:宋体'>由以下四部分组成</span><span
lang=EN-US>:</span></p>

<p class=MsoNoSpacing><span lang=EN-US>1</span><span style='font-family:宋体'>、管理服务器（</span><span
lang=EN-US>master server</span><span style='font-family:宋体'>）</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>一台管理整个文件系统的独立主机，存储着每个文件的元数据（文件的大小、属性、位置信息，包括所有非常规文件的所有信息，例如目录、套接字、管道以及设备文件）</span></p>

<p class=MsoNoSpacing><span lang=EN-US>2</span><span style='font-family:宋体'>、数据服务器群（</span><span
lang=EN-US>chunk servers</span><span style='font-family:宋体'>）</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>任意数目的商用服务器，用来存储文件数据并在彼此之间同步（如果某个文件有超过一个备份的话）</span></p>

<p class=MsoNoSpacing><span lang=EN-US>3</span><span style='font-family:宋体'>、元数据备份服务器（</span><span
lang=EN-US>metalogger server</span><span style='font-family:宋体'>）</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>任意数量的服务器，用来存储元数据变化日志并周期性下载主要元数据文件，以便用于管理服务器意外停止时好接替其位置。</span></p>

<p class=MsoNoSpacing><span lang=EN-US>4</span><span style='font-family:宋体'>、访问</span><span
lang=EN-US>mfs</span><span style='font-family:宋体'>的客户端</span></p>

<p class=MsoNoSpacing><span style='font-family:宋体'>任意数量的主机，可以通过</span><span
lang=EN-US>mfsmount</span><span style='font-family:宋体'>进程与管理服务器（接收和更改元数据）和数据服务器（改变实际文件数据）进行交流。</span></p>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<h4><span lang=EN-US>4.2.1.1</span><span style='font-family:宋体'>系统环境</span></h4>

<p class=MsoNoSpacing><span style='font-family:宋体'>系统平台：</span><span
lang=EN-US>VMware&nbsp; centos 7</span></p>

<p class=MsoNoSpacing><span lang=EN-US>mfs</span><span style='font-family:宋体'>版本：</span><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'>moosefs-2.0.77-1.tar.gz</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>IP</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-left:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span style='font-family:宋体'>作用</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.134</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Master Server </span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.143</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Logger Server</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.144</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Chunck Server1</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.146</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Chunck Server2</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.148</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Chunck Server3</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.145</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Mfs Clinet 1</span></p>
  </td>
 </tr>
 <tr>
  <td width=284 valign=top style='width:213.05pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>192.168.254.147</span></p>
  </td>
  <td width=284 valign=top style='width:213.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNoSpacing><span lang=EN-US>Mfs Clinet 2</span></p>
  </td>
 </tr>
</table>

<p class=MsoNoSpacing><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNoSpacing><span lang=EN-US>Mfs</span><span style='font-family:宋体'>部署结构图：</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=664 height=803
src="live_vod_cdn.files/image023.png"></span></p>

<p class=MsoNoSpacing><span lang=EN-US>MFS</span><span style='font-family:宋体'>读写原理图</span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=337
id="图片 16" src="live_vod_cdn.files/image024.png"></span></p>

<p class=MsoNoSpacing><span lang=EN-US><img border=0 width=554 height=367
id="图片 17" src="live_vod_cdn.files/image025.png"></span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<h3><a name="_Toc33272404"></a><a name="_Toc436141427"><span lang=EN-US>4.2.2Moosefs</span></a><span
style='font-family:宋体'>安装与配置</span></h3>

<h4><span lang=EN-US>4.2.2.1</span><span style='font-family:宋体'>元数据服务器安装和配置</span></h4>

<p class=MsoNormal align=left style='text-align:left;text-indent:24.0pt'><span
style='font-size:12.0pt;font-family:宋体'>元数据服务器可以是<span lang=EN-US>linux,</span>也可以是<span
lang=EN-US>unix,</span>你可以根据自己的使用习惯选择操作系统<span lang=EN-US>,</span>在我的环境里<span
lang=EN-US>,</span>我是用<span lang=EN-US>freebsd</span>做为<span lang=EN-US>MFS</span>元数据的运行平台。<span
lang=EN-US>GNU</span>源码，在各种类<span lang=EN-US>unix</span>平台的安装都基本一致。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) </span><span style='font-family:宋体'>安装元数据服务</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、下载<span lang=EN-US>GNU</span>源码</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-family:
宋体'>在网站</span><span lang=EN-US><a
href="http://ncu.dl.sourceforge.net/project/moosefs/moosefs">http://ncu.dl.sourceforge.net/project/moosefs/moosefs</a></span><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'> &nbsp;</span><span
style='font-size:12.0pt;font-family:宋体'>下载<span lang=EN-US>,</span>以<span
lang=EN-US>moosefs-2.0.77-1.tar.gz</span>为例</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、解包<span lang=EN-US> tar moosefs-2.0.77-1.tar.gz</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>3</span><span style='font-size:12.0pt;
font-family:宋体'>、切换目录<span lang=EN-US> cd cd moosefs-2.0.77</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>4</span><span style='font-size:12.0pt;
font-family:宋体'>、创建用户<span lang=EN-US> useradd mfs -s /sbin/nologin</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>5</span><span style='font-size:12.0pt;
font-family:宋体'>、配置<span lang=EN-US> ./configure --prefix=/usr/local/mfs
--with-default-user=mfs --with-default-group=mfs</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>6</span><span style='font-size:12.0pt;
font-family:宋体'>、编译安装<span lang=EN-US> make ; make install</span></span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>配置元数据服务</span></h5>

<p class=MsoNormal align=left style='text-align:left;text-indent:24.0pt'><span
style='font-size:12.0pt;font-family:宋体'>元数据服务器的配置文件被放置于安装目录<span lang=EN-US>/usr/local/mfs/etc</span>。安装完成只有模版文件，其后缀形如<span
lang=EN-US>mfsmaster.cfg.dist</span>。为了使<span lang=EN-US>mfs master</span>正常工作，需要两个配置文件<span
lang=EN-US>mfsmaster.cfg</span>及<span lang=EN-US>mfsexports.cfg,</span>前者为主配置文件，后者为权限控制文件（<span
lang=EN-US>mfs</span>客户 端挂接时使用）。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（<span lang=EN-US>1</span>）主配置文件<span lang=EN-US>mfsmaster.cfg,</span>可直接从模版文件拷贝而来，打开这个配置文件<span
lang=EN-US>/usr/local/mfs/etc/mfsmaster.cfg</span>，看看都有哪些内容，尽管每行都被注释掉了，但它们却是配置文件的默认值，要改变这些值，需要取消注释，然后明确指定其取值。接下来说明一下其中一些项目的含义。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ EXPORTS_FILENAME =
/usr/local/mfs/etc/mfsexports.cfg </span><span style='font-size:12.0pt;
font-family:宋体'>权限控制文件的存放位置。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ DATA_PATH = /usr/local/mfs/var/mfs </span><span
style='font-size:12.0pt;font-family:宋体'>数据存放路径，只元数据的存放路径。那么这些数据都包括哪些呢？进目录看看，大致分<span
lang=EN-US>3</span>种类型的文件：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=505 height=140 id="图片 18" src="live_vod_cdn.files/image026.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>这些文件也同样要存储在其他数据存储服务器的相关目录。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ MATOCS_LISTEN_PORT = 9420
MATOCS--master to chunkserver</span><span style='font-size:12.0pt;font-family:
宋体'>，即元数据服务器使用<span lang=EN-US>9420</span>这个监听端口来接受数据存储服务器<span lang=EN-US>chunkserver</span>端的连接。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ MATOML_LISTEN_PORT = 9419
MATOML---master to metalogger</span><span style='font-size:12.0pt;font-family:
宋体'>，用于备份元数据服务器的变化日志。注：<span lang=EN-US>Mfs-1.5.12</span>以前的版本没有这个项目。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ MATOCU_LISTEN_PORT = 9421 </span><span
style='font-size:12.0pt;font-family:宋体'>元数据服务器在<span lang=EN-US>9421</span>端口监听，用以接受客户端对<span
lang=EN-US>MFS</span>进行远程挂接（客户端以<span lang=EN-US>mfsmount</span>挂接<span
lang=EN-US>MFS</span>）</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ </span><span style='font-size:12.0pt;
font-family:宋体'>其他部分看字面意思都不难理解。还有几个与时间有关的数值，其单位是秒。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>这个配置文件，不必做修改就能工作了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（<span lang=EN-US>2</span>）配置文件<span lang=EN-US>/usr/local/mfs/etc/mfsexports.cfg,</span>也可直接从模版文件复制而来。这个文件的内容，十分类似<span
lang=EN-US> NFS</span>服务器的<span lang=EN-US>exports</span>文件．实际配置时，可参照这个文件的默认行来修改以满足自己的应用需求．</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（<span lang=EN-US>3</span>）复制文件</span></p>

<p class=MsoNormal align=left style='margin-left:6.0pt;text-align:left;
text-indent:-6.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>cp
/usr/local/mfs/var/mfs/metadata.mfs.empty /usr/local/mfs/var/mfs/metadata.mfs </span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>这是一个<span lang=EN-US>8</span>字节的文件。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>三</span><span
lang=EN-US>) </span><span style='font-family:宋体'>元数据服务器</span><span lang=EN-US>master</span><span
style='font-family:宋体'>启动</span></h5>

<p class=MsoNormal align=left style='text-align:left;text-indent:24.0pt'><span
style='font-size:12.0pt;font-family:宋体'>元数据服务器可以单独启动，即使没有任何数据存储服务器（<span
lang=EN-US>chunkserver</span>）也是能正常工作的，因此当我们安装配置完<span lang=EN-US>MFS</span>后，即可启动
它。执行命令<span lang=EN-US> /usr/local/mfs/sbin/mfsmaster start </span>，如果没有意外，元数据库服务器就应该作为一个守护进程运行起来。现在我们可以通过<span
lang=EN-US>3</span>个方面来检查一下<span lang=EN-US>MFS master</span>的运行状况：</span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:-24.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>1、<span
style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>检查</span><span style='font-family:宋体'>进程</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=29 id="图片 20" src="live_vod_cdn.files/image027.jpg"></span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:-24.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>2、<span
style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>检查网络状态</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=88 id="图片 21" src="live_vod_cdn.files/image028.jpg"></span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:-24.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>3、<span
style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>检查系统日志</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=88 id="图片 22" src="live_vod_cdn.files/image029.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>MFS</span><span style='font-size:12.0pt;
font-family:宋体'>的日志会直接写入系统日志。当我们增加数据存储服务器（<span lang=EN-US>chunkserver</span>）或数据存储服务器（<span
lang=EN-US>chunkserver</span>）处故障时，都能在系统日志找到这些记录。注意，这个日志跟元数据变化日志不是一回事情。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>四</span><span
lang=EN-US>) </span><span style='font-family:宋体'>关闭元数据服务器</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>关闭元数据服务器，务必使用 <span lang=EN-US>/usr/local/mfs/sbin/mfsmaster
stop </span>这种方式，如果直接使用<span lang=EN-US>kill</span>杀死进程，将导致下次启动时出现找不到相关文件，而不能正常启动服务器。这个一定要谨慎。当然，如果发生了这个事情，还是可以通过
<span lang=EN-US>/usr/local/mfs/sbin/mfsmaster -a</span>来恢复的。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<h4><span lang=EN-US>4.2.2.2</span><span style='font-family:宋体'>元数据日志服务器安装和配置</span></h4>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>元数据日志服务为<span lang=EN-US>mfs 1.6</span>以后版本新增的服务，即可以把元数据日志保留在元数据服务器，也可以单独存储。为保证其可靠性，最好单独放置。需要注意的是，源数据日志守护进程跟
元数据服务器（<span lang=EN-US>master</span>）在同一个服务器上，备份元数据日志的服务器作为它的客户端，从元数据服务器取得日志文件进行备份。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) </span><span style='font-family:宋体'>安装元数据日志服务器</span><span
lang=EN-US>metalogger</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、下载<span lang=EN-US>GNU</span>源码</span></p>

<p class=MsoNormal align=left style='margin-left:5.25pt;text-align:left;
text-indent:5.25pt'><span style='font-family:宋体'>在网站</span><span lang=EN-US><a
href="http://ncu.dl.sourceforge.net/project/moosefs/moosefs">http://ncu.dl.sourceforge.net/project/moosefs/moosefs</a></span><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'> &nbsp;</span><span
style='font-size:12.0pt;font-family:宋体'>下载<span lang=EN-US>,</span>以<span
lang=EN-US>moosefs-2.0.77-1.tar.gz</span>为例</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、解包<span lang=EN-US> tar moosefs-2.0.77-1.tar.gz</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>3</span><span style='font-size:12.0pt;
font-family:宋体'>、切换目录<span lang=EN-US> cd cd moosefs-2.0.77</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>4</span><span style='font-size:12.0pt;
font-family:宋体'>、创建用户<span lang=EN-US> useradd mfs -s /sbin/nologin</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>5</span><span style='font-size:12.0pt;
font-family:宋体'>、配置<span lang=EN-US> ./configure --prefix=/usr/local/mfs
--with-default-user=mfs --with-default-group=mfs</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>6</span><span style='font-size:12.0pt;
font-family:宋体'>、编译安装<span lang=EN-US> make ; make install</span></span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>元数据日志服务（</span><span
lang=EN-US>metalogger</span><span style='font-family:宋体'>）配置</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>该服务仅需要一个配置文件，这里我们只需要从模板文件复制一个，然后稍微加以修改即可，实例中<span
lang=EN-US>metalogger</span>的配置文件<span lang=EN-US>mfsmetalogger.cfg</span>，这个配置文件，唯一需要修改的地方就是<span
lang=EN-US>MASTER_HOST</span>，它的值必须是元数据服务器的主机名或者ｉｐ地址。如实例配置如下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=551 height=86 id="图片 34" src="live_vod_cdn.files/image030.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>另外，为方便大家进一步理解，配置文件里其他几个项目简单的说明一下：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（１）<span lang=EN-US>SYSLOG_IDENT = mfsmetalogger </span>元数据日志服务运行时，在系统日志输出的标识</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（２）<span lang=EN-US>DATA_PATH = /usr/local/mfs/var/mfs </span>从元数据服务器<span
lang=EN-US>(master)</span>抓回文件，然后进行存放的路径。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（３）<span lang=EN-US>BACK_LOGS = 50 </span>存放备份日志的总个数为５０，超出５０则轮转。在做元数据恢复时，仅仅需要最近的那个日志文件备份，因此默认的日志个数就足够了，这也保证了日志备份不会写满整个分区。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（４）<span lang=EN-US>META_DOWNLOAD_FREQ = 24 </span>元数据备份文件下载请求频率。默认为２４小时，即每隔一天从元数据服务器<span
lang=EN-US>(MASTER)</span>下载一个<span lang=EN-US>metadata.mfs.back</span>文件。当元数据服务器关闭或者出故障时，<span
lang=EN-US>matedata.mfs.back</span>文件将消失，那么要恢复整个<span lang=EN-US>mfs,</span>则需从<span
lang=EN-US>metalogger</span>服务器取得该文件。请特别注意这个文件，它与日志文件一起，才能够恢复整个被损坏的分布式文件系统。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>三</span><span
lang=EN-US>) </span><span style='font-family:宋体'>元数据日志服务（</span><span
lang=EN-US>metalogger</span><span style='font-family:宋体'>）运行及关闭</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>１、启动过程为： </span></p>

<p class=MsoNormal align=left style='text-align:left'><b><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>/usr/local/mfs/sbin/mfsmetalogger start</span></b></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:12.0pt'><span
style='font-size:12.0pt;font-family:宋体'>启动过程如果不能跟元数据服务器进行通信的话，系统会给出错误信息。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>２、关闭服务，执行命令 </span></p>

<p class=MsoNormal align=left style='text-align:left'><b><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>/usr/local/mfs/sbin/mfsmetalogger stop </span></b></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>３、检查服务的运行状况。从两个方面看，一个是元数据服务器，另一个是本身的数据生成情况。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆</span><span style='font-size:12.0pt;
font-family:宋体'>察看元数据服务器网络连接，可以看见日志服务器连接到元数据服务器的<span lang=EN-US>tcp 9419</span>端口。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆</span><span style='font-size:12.0pt;
font-family:宋体'>查看日志服务器的工作目录，正常情况应该看见已经有文件生成了（从元数据服务器获取过来的）。可以手动从元数据服务器复制一个日志文件过来比较文件的内容。</span></p>

<h4><span lang=EN-US>4.2.2.3</span><span style='font-family:宋体'>数据存储服务器的安装配置</span></h4>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>数据存储服务器<span lang=EN-US>chunkserver</span>也是可以运行在各种类<span
lang=EN-US>unix</span>平台的，因此不再多说。一个<span lang=EN-US>MFS</span>环境到底能集群多少服务器，作者的说法是
上<span lang=EN-US>PB</span>容量，一般建议，最好<span lang=EN-US>3</span>台以上；并且专门用来做存储，不要把它跟<span
lang=EN-US>master</span>搞到一个机器（理论上没问题，实现也是可以的，但这不是一个好策略）。 因为每个数据存储服务器的安装和配置都是相同的，所以只需按照一个服务器的操作就可以了。</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) </span><span style='font-family:宋体'>安装数据存储服务器</span><span
lang=EN-US> chunkserver</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、下载<span lang=EN-US>GNU</span>源码</span></p>

<p class=MsoNormal align=left style='margin-left:5.25pt;text-align:left;
text-indent:5.25pt'><span style='font-family:宋体'>在网站</span><span lang=EN-US><a
href="http://ncu.dl.sourceforge.net/project/moosefs/moosefs">http://ncu.dl.sourceforge.net/project/moosefs/moosefs</a></span><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'> &nbsp;</span><span
style='font-size:12.0pt;font-family:宋体'>下载<span lang=EN-US>,</span>以<span
lang=EN-US>moosefs-2.0.77-1.tar.gz</span>为例</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、解包<span lang=EN-US> tar moosefs-2.0.77-1.tar.gz</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>3</span><span style='font-size:12.0pt;
font-family:宋体'>、切换目录<span lang=EN-US> cd cd moosefs-2.0.77</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>4</span><span style='font-size:12.0pt;
font-family:宋体'>、创建用户<span lang=EN-US> useradd mfs -s /sbin/nologin</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>5</span><span style='font-size:12.0pt;
font-family:宋体'>、配置<span lang=EN-US> ./configure --prefix=/usr/local/mfs
--with-default-user=mfs --with-default-group=mfs</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>6</span><span style='font-size:12.0pt;
font-family:宋体'>、编译安装<span lang=EN-US> make ; make install</span></span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>配置数据存储服务器</span><span
lang=EN-US>chunkserver</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>数据存储服务器有<span lang=EN-US>2</span>个配置服务器需要修改，一个是主配置文件<span
lang=EN-US> mfschunkserver.cfg ,</span>另一个配置文件是<span lang=EN-US> mfshdd.cfg</span>。每个服务器用来分配给<span
lang=EN-US> MFS</span>使用的空间最好是一个单独的硬盘或者一个<span lang=EN-US>raid</span>卷，最低要求是一个分区。<span
lang=EN-US>1</span>、修改配置文件<span lang=EN-US>
/usr/local/mfs/etc/mfschunkserver.cfg</span>。下面是修改了的配置文件： </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=551 height=86 id="图片 35" src="live_vod_cdn.files/image030.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>这个配置文件里，没有注释符号<span lang=EN-US>“#”</span>就是被修改过的项了，接下来是里面某些项的含义说明：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ MASTER_HOST = 192.168.254.131 </span><span
style='font-size:12.0pt;font-family:宋体'>元数据服务器的名称或地址，可以是主机名，也可以是<span
lang=EN-US>ip</span>地址，只要数据存储服务器能访问到元数据服务器就行。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ LOCK_FILE =
/var/run/mfs/mfschunkserver.pid </span><span style='font-size:12.0pt;
font-family:宋体'>与元数据服务器<span lang=EN-US>master</span>的处理完全相同<span lang=EN-US>.</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ CSSERV_LISTEN_PORT = 9422 CSSERV―chunkserver,</span><span
style='font-size:12.0pt;font-family:宋体'>这个监听端口用于与其它数据存储服务器间的连接，通常是数据复制。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆ HDD_CONF_FILENAME = <a
name="OLE_LINK1">/usr/local/mfs/etc/mfshdd.cfg</a> </span><span
style='font-size:12.0pt;font-family:宋体'>分配给<span lang=EN-US>MFS</span>使用的磁盘空间配置文件的位置。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、修改配置文件<span lang=EN-US>/usr/local/mfs/etc/mfshdd.cfg</span>。为了使<span
lang=EN-US>mfs</span>拥有写目录的权限，需要修改目录的属主。测试服务器的分区挂接点是<span lang=EN-US> /data , </span>用<span
lang=EN-US> chown CR mfs:mfs /data </span>把属主改变。因为测试环境中每个服务器只需贡献一个分区做为<span
lang=EN-US>MFS,</span>因此配置文件只需要如下一行内容就可以了： </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=496 height=103 id="图片 25" src="live_vod_cdn.files/image031.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>&nbsp;</span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>三</span><span
lang=EN-US>) </span><span style='font-family:宋体'>启动数据存储服务器</span><span
lang=EN-US>chunkserver</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>在数据存储服务器<span lang=EN-US>chunkserver</span>执行命令<span
lang=EN-US> /usr/local/mfs/sbin/mfschunkserver start </span>启动数据存储守护进程<span
lang=EN-US>.</span>通过以下几种方式来检查<span lang=EN-US>chunkserver</span>的运行状态<span
lang=EN-US>.</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、 查看进程<span lang=EN-US> ps aux | grep mfschunkserver </span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、 查看网络状态，正常情况下应该看见<span lang=EN-US>9422</span>处于监听状态，如果有其他数据存储服务器<span
lang=EN-US>chunkserver</span>在同一个元数据服务器<span lang=EN-US>master</span>管理下运行的话，应该能看见其他<span
lang=EN-US>chunkserver</span>跟本机的连接情况<span lang=EN-US>:</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=78 id="图片 26" src="live_vod_cdn.files/image032.jpg"></span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:-24.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>4、<span
style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>查看<b>元数据服务器</b>的系统日志，可以看见新增的数据存储服务器<span
lang=EN-US>chunkserver</span>被加入。 </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=108 id="图片 27" src="live_vod_cdn.files/image033.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>5. </span><span style='font-size:12.0pt;
font-family:宋体'>启动后数据目录下显示如下</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=553 height=71 id="图片 30" src="live_vod_cdn.files/image034.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>（四） 关闭数据存储服务器</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>跟元数据服务器<span lang=EN-US>master</span>相似，执行命令 <span
lang=EN-US>/usr/local/mfs/sbin/mfschunkserver stop , chunkserver</span>服务就停下来了。</span></p>

<h4><span lang=EN-US>4.2.2.4 MFS</span><span style='font-family:宋体'>客户端的安装及配置</span></h4>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>一</span><span
lang=EN-US>) centos</span><span style='font-family:宋体'>安装</span><span
lang=EN-US>MFS</span><span style='font-family:宋体'>客户端</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆Mfsmount</span><span style='font-size:
12.0pt;font-family:宋体'>需要依赖<span lang=EN-US>FUSE,</span>因此需要先安装好<span
lang=EN-US>fuse</span>，可以下载源码编译安装，或使用命令，测试环境使用如下命令安装：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>yum install fuse fuse-devel</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>如果系统已经安装了<span lang=EN-US>fuse,</span>则跳过这个步骤。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆</span><span style='font-size:12.0pt;
font-family:宋体'>安装<span lang=EN-US>MFS</span>客户端程序</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、下载<span lang=EN-US>GNU</span>源码</span></p>

<p class=MsoNormal align=left style='margin-left:5.25pt;text-align:left;
text-indent:5.25pt'><span style='font-family:宋体'>在网站</span><span lang=EN-US><a
href="http://ncu.dl.sourceforge.net/project/moosefs/moosefs">http://ncu.dl.sourceforge.net/project/moosefs/moosefs</a></span><span
lang=EN-US style='font-size:12.0pt;font-family:宋体'> &nbsp;</span><span
style='font-size:12.0pt;font-family:宋体'>下载<span lang=EN-US>,</span>以<span
lang=EN-US>moosefs-2.0.77-1.tar.gz</span>为例</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、解包<span lang=EN-US> tar moosefs-2.0.77-1.tar.gz</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>3</span><span style='font-size:12.0pt;
font-family:宋体'>、切换目录<span lang=EN-US> cd cd moosefs-2.0.77</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>4</span><span style='font-size:12.0pt;
font-family:宋体'>、创建用户<span lang=EN-US> useradd mfs -s /sbin/nologin</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>5</span><span style='font-size:12.0pt;
font-family:宋体'>、配置<span lang=EN-US> ./configure --prefix=/usr/local/mfs
--with-default-user=mfs --with-default-group=mfs --enable-mfsmount</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>6</span><span style='font-size:12.0pt;
font-family:宋体'>、编译安装<span lang=EN-US> make ; make install</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>◆</span><span style='font-size:12.0pt;
font-family:宋体'>检查<span lang=EN-US>MFS</span>客户端安装的结果。通过查看目录<span lang=EN-US>/usr/local/mfs/bin</span>目录的文件，应该发现如下文件：</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=553 height=44 id="图片 28" src="live_vod_cdn.files/image035.jpg"></span></p>

<h5><span lang=EN-US>(</span><span style='font-family:宋体'>二</span><span
lang=EN-US>) </span><span style='font-family:宋体'>挂接和使用</span><span lang=EN-US>MFS</span><span
style='font-family:宋体'>文件系统</span></h5>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>1</span><span style='font-size:12.0pt;
font-family:宋体'>、创建挂接点<span lang=EN-US> mkdir /mnt/mfs</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>2</span><span style='font-size:12.0pt;
font-family:宋体'>、挂接<span lang=EN-US>MFS /usr/local/mfs/bin/mfsmount /mnt/mfs
-H&nbsp; 192.168.254.131</span>注意，所有的<span lang=EN-US>MFS</span>都是挂接同一个元数据服务器<span
lang=EN-US>master,</span>而不是其他数据存储服务器<span lang=EN-US>chunkserver !</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>3</span><span style='font-size:12.0pt;
font-family:宋体'>、通过查看磁盘使用情况来检查是否被挂接成功。 </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=522 height=130 id="图片 29" src="live_vod_cdn.files/image036.png"></span></p>

<p class=MsoNormal><span style='font-size:12.0pt;font-family:宋体'>以上面结果只是有一个<span
lang=EN-US>chunckserver </span>最大可用空间为<span lang=EN-US>18G,</span>下面显示添加一台新的<span
lang=EN-US>chunckserver</span>后的结果</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=507 height=123
id="图片 31" src="live_vod_cdn.files/image037.png"></span></p>

<p class=MsoNormal><span style='font-size:12.0pt;font-family:宋体'>现在变成<span
lang=EN-US>35G</span>空间。</span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:-24.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>5、<span
style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>进入目录<span lang=EN-US>/mnt/mfs</span>，上传一个文件，看是否正常？</span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:0cm'><span lang=EN-US><img border=0 width=554 height=69 id="图片 33"
src="live_vod_cdn.files/image038.jpg"></span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:0cm'><span style='font-size:12.0pt;font-family:宋体'>接着在手动用<span
lang=EN-US>touch </span>创建一个文件，然后再删除它们，看是否可以正常操作。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>6 </span><span style='font-size:12.0pt;
font-family:宋体'>设置文件副本数量，建议以<span lang=EN-US>3</span>份为佳。 </span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>设置副本数目</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>/usr/local/mfs/bin/mfsrsetgoal&nbsp; 3
/mnt/mfs/moosefs-2.0.77-1.tar.gz</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:
12.0pt;font-family:宋体'>查看设置是否如我所愿</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='font-size:12.0pt;font-family:宋体'>/usr/local/mfs/bin/mfsgetgoal -r /mnt/mfs/moosefs-2.0.77-1.tar.gz</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=554 height=45 id="图片 32" src="live_vod_cdn.files/image039.jpg"></span></p>

<p class=MsoListParagraph align=left style='margin-left:18.0pt;text-align:left;
text-indent:-18.0pt'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>7<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
style='font-size:12.0pt;font-family:宋体'>设置删除文件后空间回收时间。默认的回收时间为<span lang=EN-US>7</span>天（<span
lang=EN-US>604800</span>秒） </span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:0cm'><span style='font-size:12.0pt;font-family:宋体'>修改回收时间为<span
lang=EN-US>10</span>分钟</span></p>

<p class=MsoListParagraph align=left style='margin-left:24.0pt;text-align:left;
text-indent:0cm'><span lang=EN-US style='font-size:12.0pt;font-family:宋体'>/usr/local/mfs/bin/mfsrsettrashtime
&nbsp;600 /mnt/mfs</span></p>

</div>

</body>

</html>
